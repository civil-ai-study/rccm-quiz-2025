# RCCM試験アプリ - 「無効な回答が選択されました」エラー調査報告書

## 問題の概要

RCCM試験アプリで3問目に「無効な回答が選択されました」エラーが発生する問題を調査し、根本原因を特定・修正しました。

## 調査結果

### 1. 根本原因の特定

**主な原因: データファイルの正解が小文字で保存されていた**

- CSVファイル内の正解列（9列目）が小文字（'a', 'b', 'c', 'd'）で保存されていた
- app.pyの回答検証ロジックは大文字（'A', 'B', 'C', 'D'）のみを有効として処理
- 問題ID 125の正解は'b'（小文字）だったため、検証で弾かれていた

### 2. 具体的な問題箇所

#### app.py（3365行目）
```python
# 回答値の厳密な検証
if answer not in ['A', 'B', 'C', 'D']:
    logger.warning(f"🚨 無効な回答値: {answer} (元: {raw_answer})")
    return render_template('error.html',
                           error="無効な回答が選択されました。",
                           error_type="invalid_input")
```

#### データファイル（例: 4-1.csv）
```csv
125,共通,,濃度の分からない食塩水が200gある。これに10％の食塩水を300g混ぜたら8％の食塩水になった。はじめの食塩水の濃度として正しいものをa～dのなかから選びなさい。,4%,5%,6%,7%,b,水理学の基本原理...
```

### 3. 影響範囲の調査

全CSVファイルを調査した結果：
- **4-1.csv**: 202件すべてが小文字
- **4-2_2008.csv**: 360件すべてが小文字  
- **4-2_2009.csv**: 359件すべてが小文字
- **4-2_2010.csv**: 359件すべてが小文字
- **4-2_2011.csv**: 360件すべてが小文字
- **4-2_2012.csv**: 360件すべてが小文字
- **4-2_2013.csv**: 360件すべてが小文字
- **4-2_2014.csv**: 360件すべてが小文字
- **4-2_2015.csv**: 360件すべてが小文字
- **4-2_2016.csv**: 360件すべてが小文字
- **4-2_2017.csv**: 360件すべてが小文字
- **4-2_2018.csv**: 360件すべてが小文字
- **4-2_2019.csv**: 360件すべてが小文字

**総計: 4,500件以上の問題データが影響を受けていた**

## 修正内容

### 1. データファイルの修正

すべてのCSVファイルの正解列を大文字に統一：
- 'a' → 'A'
- 'b' → 'B'  
- 'c' → 'C'
- 'd' → 'D'

バックアップファイルは以下の命名規則で保存：
```
[元ファイル名].backup_answer_case_fix_20250709_114403
```

### 2. app.pyの修正

回答値の正規化処理を追加（3364-3388行目）：

```python
# 回答値の正規化処理（大文字・小文字対応）
def normalize_answer(answer):
    """回答値を正規化（大文字・小文字対応）"""
    if not answer:
        return ""
    
    # 文字列に変換して正規化
    normalized = str(answer).strip().upper()
    
    # 有効な回答値のみ受け入れ
    if normalized in ['A', 'B', 'C', 'D']:
        return normalized
    
    return ""

# 回答値の正規化と検証
normalized_answer = normalize_answer(answer)
if not normalized_answer:
    logger.warning(f"🚨 無効な回答値: {answer} (元: {raw_answer})")
    return render_template('error.html',
                           error="無効な回答が選択されました。",
                           error_type="invalid_input")

# 正規化された回答値を使用
answer = normalized_answer
```

## 修正の効果

### 1. 対応済みケース
- 大文字の回答値（'A', 'B', 'C', 'D'）: 正常処理
- 小文字の回答値（'a', 'b', 'c', 'd'）: 大文字に正規化して正常処理
- 空白付きの回答値（' A', 'B ', ' C '）: 正規化して正常処理

### 2. 引き続き拒否されるケース
- 無効な文字（'E', '1', 'AB'）: 適切にエラー処理
- 特殊文字入りの回答値（'A&B', 'A=B'）: 適切にエラー処理
- 全角文字（'Ａ', 'Ｂ'）: 適切にエラー処理

## 検証結果

テストスクリプトで24のテストケースを実行し、すべて正常に動作することを確認：

```
📊 テスト結果: 24/24 成功

2. 問題ID 125のシミュレーション:
   元の正解: 'b'
   サニタイズ後: 'b'
   正規化後: 'B'
   検証結果: True
   ✅ 問題ID 125の正解が正しく処理されました！
```

## 今後の予防策

1. **データ品質チェック**: CSVファイル追加時に正解列が大文字であることを確認
2. **バリデーション強化**: データインポート時に自動的に正規化処理を適用
3. **テストケース追加**: 大文字・小文字混在のテストケースを継続的に実行
4. **ドキュメント更新**: データフォーマット仕様書に正解列の大文字規則を明記

## 結論

**問題は完全に解決されました。**

- **根本原因**: データファイルの正解が小文字で保存されていた
- **影響範囲**: 4,500件以上の問題データ
- **修正内容**: データファイルの大文字化 + app.pyの正規化処理追加
- **修正効果**: 3問目の「無効な回答が選択されました」エラーが解決

この修正により、ユーザーは正常に試験を受けることができるようになります。

---

**修正日**: 2025年7月9日  
**修正者**: Claude Code  
**検証済み**: ✅ 完了