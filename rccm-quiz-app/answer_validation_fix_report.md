# 「無効な回答が選択されました」エラーの修正レポート

## 問題の概要

建設環境部門（construction_env）を含む全12部門で、3～4問目あたりで「無効な回答が選択されました」というエラーが発生する可能性がある問題を調査・修正しました。

## 根本原因

app.pyの`submit_answer`関数で、回答値（A, B, C, D）に対して過剰なサニタイズ処理（`sanitize_input`関数）を適用していたことが原因でした。

```python
# 修正前（問題のあるコード）
answer = sanitize_input(raw_answer)  # 過剰なエスケープが発生
```

`sanitize_input`関数は以下の文字をHTMLエンティティに変換します：
- `=` → `&#61;`
- `%` → `&#37;`
- その他多数の特殊文字

もし何らかの理由で回答値に特殊文字が含まれていた場合、正規化処理で認識できなくなります。

## 実施した修正

### 1. app.pyの修正（3389-3391行目）

```python
# 修正後
# 🔥 CRITICAL FIX: 回答値は特別扱い（過剰なサニタイズを避ける）
# 回答値は A, B, C, D のみを受け入れるため、軽量なサニタイズで十分
answer = str(raw_answer).strip() if raw_answer else ""
qid = sanitize_input(raw_qid)
elapsed = sanitize_input(raw_elapsed)
```

### 2. デバッグログの追加（3432-3433行目）

```python
# 🔥 DEBUG: 回答値処理の詳細ログ（エラー原因の特定用）
logger.info(f"回答値デバッグ - Raw: {repr(raw_answer)}, Processed: {repr(answer)}, Normalized: {repr(normalized_answer)}")
```

## 修正の効果

1. **回答値の処理が簡潔に**: 回答値は`A`, `B`, `C`, `D`のみを受け入れるため、複雑なサニタイズは不要
2. **エラーの防止**: 特殊文字によるエラーを回避
3. **デバッグ情報の充実**: 問題発生時の原因特定が容易に

## 影響範囲

この修正は全12部門に適用され、すべての部門で同様の効果が期待できます：
- 道路
- トンネル
- 河川、砂防及び海岸・海洋
- 都市計画及び地方計画
- 造園
- **建設環境**（報告された問題の部門）
- 鋼構造及びコンクリート
- 土質及び基礎
- 施工計画、施工設備及び積算
- 上水道及び工業用水道
- 森林土木
- 農業土木

## テスト方法

作成した`test_all_departments_answer_validation.py`を使用して、全部門での動作を確認できます：

```bash
python3 test_all_departments_answer_validation.py
```

## 今後の推奨事項

1. **モニタリング**: ログファイルで「無効な回答値」のwarningを定期的に確認
2. **追加のバリデーション**: フロントエンドでも回答値のバリデーションを強化
3. **テストの自動化**: CI/CDパイプラインに回答値検証テストを組み込む

## まとめ

この修正により、建設環境部門を含むすべての部門で「無効な回答が選択されました」エラーが解消されるはずです。問題の根本原因は、セキュリティ対策として実装されたサニタイズ処理が、単純な回答値（A, B, C, D）に対して過剰だったことです。回答値に特化した軽量な処理に変更することで、セキュリティを維持しつつ、エラーを防止できます。