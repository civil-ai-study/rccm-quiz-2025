# RCCM試験アプリ完全フローチャート

## 1. 全体アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│                    RCCM試験アプリ全体構成                         │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │
│ │   app.py    │  │   utils.py  │  │  config.py  │  │ CSVデータ │ │
│ │(メイン制御) │  │(ユーティリティ)│  │   (設定)   │  │ファイル  │ │
│ └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘ │
│                                                                 │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │                  データ構造                                 │ │
│ │ • 4-1.csv (基礎科目)                                        │ │
│ │ • 4-2_YYYY.csv (専門科目・年度別)                           │ │
│ │ • 12部門の専門科目データ                                    │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 2. アプリケーション起動フロー

```
START (アプリケーション起動)
│
├─ Flask アプリケーション初期化
│  ├─ config.py から設定読み込み
│  ├─ セッション管理設定
│  ├─ セキュリティヘッダー設定
│  └─ ルーティング設定
│
├─ データ事前読み込み (preload_startup_data)
│  ├─ EnterpriseDataManager による並列読み込み
│  ├─ 4-1.csv (基礎科目) 読み込み
│  ├─ 4-2_YYYY.csv (専門科目・年度別) 読み込み
│  └─ Redisキャッシュ・LRUキャッシュ設定
│
├─ 部門マッピング初期化
│  ├─ 12部門の定義読み込み
│  ├─ カテゴリ→部門マッピング作成
│  └─ 英語↔日本語カテゴリ名変換テーブル作成
│
└─ サーバー起動
   └─ / (ルートURL) アクセス可能状態
```

## 3. メイン試験フロー

```
START (ユーザーアクセス)
│
├─ / (ルートページ)
│  ├─ index.html 表示
│  ├─ 部門選択画面
│  └─ 試験開始オプション表示
│
├─ 部門選択処理
│  ├─ 基礎科目 (4-1) 選択
│  │  ├─ 共通問題 (年度不問)
│  │  └─ 全部門共通
│  │
│  └─ 専門科目 (4-2) 選択
│     ├─ 12部門から選択
│     ├─ 年度選択 (2008-2019)
│     └─ 部門×年度の組み合わせ
│
├─ /start_exam/<exam_type> (試験開始)
│  ├─ HTTP 431対策 (GET/POST両対応)
│  ├─ パラメータ取得・検証
│  │  ├─ 問題数 (デフォルト10問)
│  │  ├─ 年度 (専門科目の場合)
│  │  └─ 部門 (専門科目の場合)
│  │
│  ├─ データ読み込み処理
│  │  ├─ 基礎科目: load_basic_questions_only()
│  │  └─ 専門科目: load_specialist_questions_only()
│  │
│  ├─ 問題選択・シャッフル
│  │  ├─ 指定問題数分をランダム選択
│  │  ├─ ID重複解決処理
│  │  └─ セッションに保存
│  │
│  └─ /exam へリダイレクト
│
├─ /exam (問題表示)
│  ├─ セッション検証
│  │  ├─ exam_session 存在確認
│  │  └─ 問題データ整合性チェック
│  │
│  ├─ 現在問題取得
│  │  ├─ SessionStateManager.get_safe_indices()
│  │  ├─ 軽量セッションからの問題復元
│  │  └─ 問題データ表示準備
│  │
│  ├─ 問題表示
│  │  ├─ exam.html レンダリング
│  │  ├─ 問題文・選択肢表示
│  │  └─ 進捗表示
│  │
│  └─ 回答受付待機
│
├─ 回答処理 (POST /exam)
│  ├─ 回答データ受信
│  │  ├─ 選択肢取得
│  │  ├─ 回答時間記録
│  │  └─ セッション更新
│  │
│  ├─ 正解判定
│  │  ├─ 正解・不正解判定
│  │  ├─ 解説表示
│  │  └─ 統計更新
│  │
│  ├─ 次問題判定
│  │  ├─ 最終問題チェック
│  │  ├─ 継続 → 次問題表示
│  │  └─ 終了 → 結果画面
│  │
│  └─ セッション状態更新
│
├─ /result (結果表示)
│  ├─ 試験結果計算
│  │  ├─ 正解数・正解率計算
│  │  ├─ 部門別成績分析
│  │  └─ 時間統計
│  │
│  ├─ 結果表示
│  │  ├─ result.html レンダリング
│  │  ├─ 成績グラフ表示
│  │  └─ 復習リンク
│  │
│  └─ セッション清理
│
└─ END (試験完了)
```

## 4. データ読み込み処理詳細

```
データ読み込み開始
│
├─ utils.py での処理
│  ├─ validate_file_path() - セキュリティチェック
│  ├─ load_questions_improved() - メイン読み込み関数
│  │  ├─ Redisキャッシュ確認
│  │  ├─ ファイル存在・サイズ確認
│  │  ├─ エンコーディング自動判定
│  │  │  ├─ utf-8-sig, utf-8, shift_jis, cp932
│  │  │  └─ iso-2022-jp の順に試行
│  │  └─ CSV解析・データ検証
│  │
│  ├─ validate_question_data() - 個別問題検証
│  │  ├─ 必須フィールド確認
│  │  ├─ 選択肢完整性チェック
│  │  ├─ 正解値正規化
│  │  └─ データ構造統一
│  │
│  └─ resolve_id_conflicts() - ID重複解決
│     ├─ 基礎科目: 1-1000番台
│     ├─ 専門科目: 1001-10000番台
│     └─ その他: 10001番台以降
│
├─ 専門科目処理
│  ├─ map_category_to_department() - カテゴリマッピング
│  │  ├─ 「道路」→ 'road'
│  │  ├─ 「河川、砂防及び海岸・海洋」→ 'civil_planning'
│  │  ├─ 「都市計画及び地方計画」→ 'urban_planning'
│  │  └─ 他9部門のマッピング
│  │
│  └─ 年度別ファイル処理
│     ├─ 4-2_2008.csv～4-2_2019.csv
│     ├─ 年度情報付与
│     └─ 部門情報付与
│
└─ キャッシュ処理
   ├─ LRUCache保存
   ├─ Redisキャッシュ保存
   └─ 統計情報更新
```

## 5. セッション管理システム

```
セッション管理開始
│
├─ SessionStateManager クラス
│  ├─ セッション状態一元管理
│  ├─ get_safe_indices() - 安全なインデックス計算
│  └─ validate_session() - セッション検証
│
├─ 軽量セッション管理
│  ├─ HTTP 431対策
│  ├─ 問題IDのみセッション保存
│  ├─ 完全データは都度復元
│  └─ メモリ効率化
│
├─ セッション永続化
│  ├─ session.permanent = True
│  ├─ session.modified = True
│  └─ critical_routes での強制保存
│
└─ エラーハンドリング
   ├─ セッション破損検出
   ├─ 緊急フォールバック
   └─ 自動復旧処理
```

## 6. 部門マッピング処理

```
部門マッピング開始
│
├─ config.py での部門定義
│  ├─ RCCMConfig.DEPARTMENTS
│  ├─ 12部門の詳細情報
│  └─ アイコン・色情報
│
├─ カテゴリ名変換処理
│  ├─ 英語部門ID ↔ 日本語部門名
│  ├─ 年度による表記違い対応
│  │  ├─ 「河川砂防海岸」(2008) → 'civil_planning'
│  │  ├─ 「河川、砂防及び海岸・海洋」(2012) → 'civil_planning'
│  │  └─ 「施工計画施工設備積算」→ 'construction_planning'
│  │
│  └─ get_safe_category_name() - 安全な変換
│
├─ 基礎科目特別処理
│  ├─ 全部門共通 ('common')
│  ├─ カテゴリ: '共通'
│  └─ 年度: null
│
└─ 専門科目処理
   ├─ 部門別分類
   ├─ 年度情報付与
   └─ カテゴリ統一
```

## 7. 問題表示ロジック

```C
├─ 現在問題取得
│  ├─ exam_current インデックス取得
│  ├─ exam_question_ids から問題ID取得
│  ├─ load_question_from_lightweight_session()
│  └─ 問題データ復元
│
├─ 問題表示準備
│  ├─ 問題文・選択肢整形
│  ├─ 進捗計算 (x/10)
│  ├─ 前問題・次問題ナビゲーション
│  └─ タイマー情報
│
├─ exam.html レンダリング
│  ├─ 問題文表示
│  ├─ 選択肢 (A/B/C/D)
│  ├─ 進捗バー
│  └─ 操作ボタン
│
└─ JavaScriptイベント
   ├─ 回答選択
   ├─ 次問題ボタン
   └─ 試験終了ボタン
```

## 8. 回答処理フロー

```
回答処理開始
│
├─ POST /exam 受信
│  ├─ 回答データ取得
│  ├─ CSRF保護確認
│  └─ セッション検証
│
├─ 回答検証・記録
│  ├─ 選択肢妥当性チェック
│  ├─ 回答時間記録
│  ├─ 正解判定
│  └─ 統計更新
│
├─ 次問題判定
│  ├─ current_no インクリメント
│  ├─ 最終問題チェック
│  │  ├─ 継続: 次問題表示
│  │  └─ 終了: 結果画面へ
│  │
│  └─ セッション状態更新
│
├─ SRS (間隔反復学習) 処理
│  ├─ 正解・不正解履歴記録
│  ├─ 復習スケジュール計算
│  └─ 学習進捗更新
│
└─ レスポンス生成
   ├─ 成功: 次問題 or 結果画面
   └─ エラー: エラーページ
```

## 9. 結果表示処理

```
結果表示開始
│
├─ /result ルート処理
│  ├─ セッション検証
│  └─ 結果データ取得
│
├─ 成績計算
│  ├─ 正解数・正解率計算
│  ├─ 部門別正解率
│  ├─ 時間統計
│  └─ 難易度別分析
│
├─ 結果表示準備
│  ├─ グラフデータ生成
│  ├─ 復習対象問題抽出
│  └─ 学習アドバイス生成
│
├─ result.html レンダリング
│  ├─ 成績サマリー
│  ├─ 詳細分析
│  ├─ 復習リンク
│  └─ 再挑戦オプション
│
└─ セッション清理
   ├─ 試験データ削除
   ├─ 統計データ保持
   └─ メモリ解放
```

## 10. エラーハンドリング体系

```
エラーハンドリング開始
│
├─ アプリケーションレベル
│  ├─ try-catch による包括的例外処理
│  ├─ ログ記録 (rotating file handler)
│  └─ 緊急フォールバック処理
│
├─ データ読み込みエラー
│  ├─ DataLoadError
│  ├─ DataValidationError
│  ├─ ファイル不存在エラー
│  └─ エンコーディングエラー
│
├─ セッション関連エラー
│  ├─ セッション破損検出
│  ├─ タイムアウト処理
│  └─ 自動復旧処理
│
├─ HTTP エラー対応
│  ├─ HTTP 431 (Request Header Fields Too Large)
│  ├─ POST移行対応
│  └─ ペイロードサイズ制限
│
└─ ユーザー向けエラー表示
   ├─ error.html テンプレート
   ├─ 分かりやすいエラーメッセージ
   └─ 復旧手順案内
```

## 11. 現在の問題点と課題

```
問題点分析
│
├─ セッション管理
│  ├─ 軽量セッション vs 完全データ保存のバランス
│  ├─ HTTP 431 対策の複雑性
│  └─ セッション永続化の不安定性
│
├─ データ処理
│  ├─ ID重複解決の複雑性
│  ├─ 部門マッピングの年度依存性
│  └─ エンコーディング判定の非効率性
│
├─ パフォーマンス
│  ├─ 大量データ読み込み時の遅延
│  ├─ キャッシュ効率の改善余地
│  └─ メモリ使用量の最適化
│
└─ 保守性
   ├─ 複雑な例外処理構造
   ├─ 多重バックアップシステム
   └─ デバッグ情報の過多
```

## 12. 技術スタック詳細

```
技術構成
│
├─ バックエンド
│  ├─ Flask (Python Web Framework)
│  ├─ セッション管理 (Flask-Session)
│  ├─ CSV処理 (Python標準ライブラリ)
│  └─ ログ管理 (logging + rotating handler)
│
├─ フロントエンド
│  ├─ HTML5 + Jinja2テンプレート
│  ├─ JavaScript (バニラ)
│  ├─ CSS3 + レスポンシブデザイン
│  └─ Bootstrap (UI framework)
│
├─ データストレージ
│  ├─ CSV ファイル (問題データ)
│  ├─ セッション (Flask session)
│  ├─ LRUCache (メモリキャッシュ)
│  └─ Redis (オプション)
│
├─ セキュリティ
│  ├─ CSRF保護
│  ├─ XSS防止
│  ├─ セッション暗号化
│  └─ パストラバーサル対策
│
└─ デプロイメント
   ├─ Render.com (クラウドホスティング)
   ├─ Gunicorn (WSGIサーバー)
   └─ 環境変数管理
```

## 13. データフロー図

```
データフロー全体
│
CSV Files → utils.py → Cache → app.py → Session → Templates → User
    │         │         │        │        │         │        │
    │         ├─ 検証   ├─ 保存  ├─ 処理  ├─ 状態   ├─ 表示  ├─ 操作
    │         ├─ 変換   ├─ 取得  ├─ 判定  ├─ 管理   ├─ 反応  └─ 入力
    │         └─ 修復   └─ 統計  └─ 制御  └─ 永続化 └─ 更新      │
    │                                                           │
    └─ 4-1.csv (基礎) + 4-2_YYYY.csv (専門) ←─────────────────────┘
       ↓
    統合データ → ID解決 → 部門分類 → 問題選択 → セッション保存
```

---

このフローチャートは、RCCM試験アプリの全体的な動作を包括的に示しています。アプリケーションの起動から試験完了まで、また各コンポーネント間の相互作用と現在の問題点を明確に把握できます。

**主要な特徴：**
1. **完全分離設計**: 基礎科目(4-1)と専門科目(4-2)の完全分離
2. **HTTP 431対策**: 軽量セッション + POST移行
3. **堅牢なエラー処理**: 多層防御とフォールバック
4. **高性能キャッシュ**: Redis + LRU の多層キャッシュ
5. **セキュリティ強化**: 包括的なセキュリティ対策

**改善が必要な領域：**
- セッション管理の簡素化
- データ処理の効率化
- エラーハンドリングの整理
- パフォーマンスの最適化