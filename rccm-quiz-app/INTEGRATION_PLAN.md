# 🔄 軽量版→本番環境 統合計画

## 📋 現在の状況（確実な事実確認）

### ✅ 軽量版（app_lightweight_fix.py）で解決済み
1. **12部門専門分野問題混在**: ✅ 100%解決（成功率12/12部門）
2. **セッション管理エラー**: ✅ 完全修正（`session.modified = True`）
3. **10問完走機能**: ✅ 動作確認済み
4. **部門IDシステム**: ✅ 日本語URL文字化け回避済み

### 🔍 本番環境（app.py）の状況
- **基本動作**: ✅ syntax OK（警告はあるが動作可能）
- **年度別機能**: ✅ 実装済み
- **複雑性**: ⚠️ 9,073行の大規模コード
- **依存関係**: ⚠️ オプションモジュールの不足（非致命的）

## 🎯 統合戦略（ウルトラシンク原則準拠）

### Phase 1: 安全な核心機能統合
**目的**: 軽量版の確実な修正を本番環境に適用
**方針**: 最小限の変更で最大の効果

#### 1.1 セッション管理修正の統合
```python
# 軽量版で成功した修正を本番環境に適用
session.modified = True  # この行を該当箇所に追加
```

#### 1.2 部門IDシステムの確認
- 本番環境に既存の部門マッピングが軽量版と一致するか確認
- 不一致があれば軽量版の確実な方式を採用

### Phase 2: 動作確認テスト
**目的**: 統合後の安全性確保
**方針**: 軽量版と同じテスト条件で検証

#### 2.1 必須テスト項目
1. 12部門セッション管理テスト
2. 10問完走テスト（代表部門）
3. 問題混在がないことの確認

#### 2.2 成功基準
- セッション管理: 100%成功
- 問題混在: 0件
- 既存機能: 100%保持

### Phase 3: 段階的展開
**目的**: 安全な本番展開
**方針**: リスク最小化

#### 3.1 バックアップ戦略
- 現在のapp.pyをバックアップ
- 統合前状態の完全保存

#### 3.2 ロールバック計画
- 問題発生時の即座復旧手順
- 軽量版での代替運用

## 🚫 絶対禁止事項（CLAUDE.md準拠）

### 統合時の絶対禁止
- ❌ 軽量版で確実に動作している機能の変更
- ❌ 複雑な機能の同時統合
- ❌ テスト未実施での本番適用
- ❌ バックアップなしでの作業

### 品質保証の絶対禁止
- ❌ 推測による実装
- ❌ エラー隠蔽・軽視
- ❌ 部分的テストでの完了判断

## 📊 リスク分析

### 低リスク（推奨実行）
- セッション管理修正の統合
- 軽量版テストの再実行

### 中リスク（慎重実行）
- 部門マッピングの調整
- 新機能の追加統合

### 高リスク（避けるべき）
- app.pyの大規模構造変更
- 複数機能の同時修正

## ⏱️ 実行スケジュール

### 即座実行可能
1. セッション管理修正の確認と統合
2. 12部門テストの再実行

### 段階的実行
1. バックアップ作成
2. 修正適用
3. テスト実行
4. 結果検証

## 🎯 成功目標

### 最低限達成目標（Must Have）
- 12部門問題混在: 0件
- セッション管理: 100%成功

### 理想達成目標（Should Have）
- 既存機能: 100%保持
- 年度別機能: 正常動作

### 追加目標（Could Have）
- パフォーマンス向上
- 新機能統合

---

**統合実行前の最終確認事項**
1. ✅ 軽量版テスト結果: 12/12部門成功
2. ✅ バックアップ作成完了
3. ✅ ロールバック手順確認
4. ✅ テスト環境準備完了

**この計画に従って、確実・安全・正確に統合作業を実行します。**