# 包括的問題混在修正計画

## 現状の問題

**発見された問題箇所数: 26箇所**
- 修正済み: 2箇所
- **未修正: 24箇所** ← これが2週間続く混在問題の根本原因

## 修正戦略

### Phase 1: 高優先度箇所の修正（主要な問題表示機能）

#### 1. exam() 関数内の修正（2箇所）
- **行4464**: `all_questions = load_questions()` 
  - specialist URLパラメーター処理
  - 修正: `get_department_questions_ultrasync()` を使用
  
- **行5408**: `all_questions = load_questions()`
  - 緊急フォールバック処理  
  - 修正: 部門別読み込みに変更

#### 2. start_exam() 関数内の修正（2箇所）
- **行9679**: `all_questions = load_questions()`
- **行9691**: `all_questions = load_questions()`
- 修正: 部門特化型読み込みに変更

#### 3. 部門関連処理の修正（3箇所）
- **行6820**: 部門進捗計算処理
- **行6874**: 部門データ存在チェック処理
- **行6962**: 問題種別カテゴリ処理
- 修正: 部門別データアクセスに変更

### Phase 2: 中優先度箇所の修正（17箇所）

残りの17箇所を順次修正：
- 行7107, 7119, 7210, 7303, 7524, 7870, 7888, 7906
- 行8091, 8840, 8923, 9314
- 行10567, 10585, 10718
- 行12701, 12706

### Phase 3: 統合テスト・検証

全修正完了後：
1. 森林土木部門テスト（上水道問題混在チェック）
2. 全12部門テスト
3. セッション統合性テスト
4. エラー回復テスト

## 修正の実装方針

### 基本的な置き換えパターン

#### Before (問題のあるコード):
```python
questions = load_questions()
filtered = [q for q in questions if q.get('category') == target_category]
```

#### After (修正後のコード):
```python
# 部門が分かっている場合
questions = get_department_questions_ultrasync(department, question_count)

# 基礎科目の場合  
from utils import load_basic_questions_only
questions = load_basic_questions_only(data_dir)
```

### 修正時の安全対策

1. **バックアップ作成**: 各修正前にファイルバックアップ
2. **段階的修正**: 1箇所ずつ修正してテスト
3. **影響範囲確認**: 修正後に関連機能をテスト
4. **ロールバック準備**: 問題発生時の即座復旧

## 予想される効果

この包括的修正により解決される問題：
- ✅ 森林土木部門での上水道問題混在
- ✅ 他11部門での同様な混在問題  
- ✅ セッション間での問題データ汚染
- ✅ IDベース検索での誤取得
- ✅ 年度データの意図しない混在

## タイムライン

- **Phase 1**: 高優先度7箇所修正 - 2時間
- **Phase 2**: 中優先度17箇所修正 - 3時間  
- **Phase 3**: 統合テスト・検証 - 1時間
- **合計**: 6時間

## 成功指標

修正完了の判定基準：
1. **森林土木部門テスト**: 上水道問題0件
2. **全部門純度テスト**: 各部門100%純度
3. **統合セッションテスト**: エラー0件
4. **2週間問題解決**: ユーザー報告の問題再現不可

## リスク管理

### 想定されるリスク
- **修正中のシステム停止**: 段階的修正で最小化
- **新たなバグ導入**: 各段階でのテスト実行
- **性能劣化**: 部門別読み込みの効率性確認

### 緊急時対応
- **即座ロールバック**: Git commit単位での復旧
- **最小限修正**: 最重要箇所のみ先行修正
- **ユーザー通知**: 修正作業中の状況説明

---

**この計画で2週間続いた混在問題を根本的に解決します**