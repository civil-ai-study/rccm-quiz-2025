/**
 * RCCMå­¦ç¿’ã‚¢ãƒ—ãƒª - ãƒ¢ãƒã‚¤ãƒ«æ©Ÿèƒ½å¼·åŒ– JavaScript
 * PWAã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€éŸ³å£°ã€ã‚¿ãƒƒãƒæ“ä½œ
 */

class MobileFeatures {
    constructor() {
        this.isOnline = navigator.onLine;
        this.touchStartX = 0;
        this.touchStartY = 0;
        this.touchStartTime = 0;
        this.speechSynthesis = window.speechSynthesis;
        this.currentSpeech = null;
        this.voiceSettings = {
            enabled: true,
            language: 'ja-JP',
            rate: 1.0,
            pitch: 1.0,
            volume: 0.8
        };
        
        this.init();
    }

    init() {
        this.setupPWA();
        this.setupOfflineHandler();
        this.setupTouchGestures();
        this.setupVoiceFeatures();
        this.setupKeyboardShortcuts();
        this.setupPerformanceMonitoring();
        this.setupAccessibilityFeatures();
        this.setupErrorBoundary();
        this.loadSettings();
        
        console.log('Mobile features initialized');
    }

    // PWAæ©Ÿèƒ½ã®è¨­å®š
    setupPWA() {
        // Service Workerã®ç™»éŒ²
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                    
                    // æ›´æ–°ãƒã‚§ãƒƒã‚¯
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                this.showUpdateNotification();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‡¦ç†
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            this.showInstallButton(deferredPrompt);
        });

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ã®å‡¦ç†
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed');
            this.hideInstallButton();
            this.showToast('ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸï¼', 'success');
        });
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã®è¨­å®š
    setupOfflineHandler() {
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.handleOnlineStateChange(true);
        });

        window.addEventListener('offline', () => {
            this.isOnline = false;
            this.handleOnlineStateChange(false);
        });

        // IndexedDBã§ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        this.setupIndexedDB();
        
        // å®šæœŸçš„ãªåŒæœŸ
        if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
            this.setupBackgroundSync();
        }
    }

    // ã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®è¨­å®š
    setupTouchGestures() {
        if (!('ontouchstart' in window)) return;

        const quizContainer = document.querySelector('.quiz-container, .exam-container');
        if (!quizContainer) return;

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
        quizContainer.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
        quizContainer.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
        quizContainer.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });

        // é•·æŠ¼ã—é˜²æ­¢ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
        quizContainer.addEventListener('contextmenu', (e) => e.preventDefault());
    }

    // éŸ³å£°æ©Ÿèƒ½ã®è¨­å®š
    setupVoiceFeatures() {
        if (!this.speechSynthesis) {
            console.warn('Speech Synthesis not supported');
            return;
        }

        // éŸ³å£°èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³ã®è¿½åŠ 
        this.addVoiceControls();
        
        // éŸ³å£°èªè­˜ã®è¨­å®šï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            this.setupSpeechRecognition();
        }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + æ•°å­—ã§ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ
            if ((e.ctrlKey || e.metaKey) && /^[1-4]$/.test(e.key)) {
                e.preventDefault();
                this.selectAnswer(['A', 'B', 'C', 'D'][parseInt(e.key) - 1]);
            }
            
            // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§éŸ³å£°èª­ã¿ä¸Šã’
            if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                this.toggleSpeech();
            }
            
            // å·¦å³çŸ¢å°ã§å‰å¾Œã®å•é¡Œ
            if (e.code === 'ArrowLeft' && e.altKey) {
                e.preventDefault();
                this.navigateQuestion('prev');
            }
            if (e.code === 'ArrowRight' && e.altKey) {
                e.preventDefault();
                this.navigateQuestion('next');
            }
        });
    }

    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
    setupPerformanceMonitoring() {
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚é–“ã®æ¸¬å®š
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const navigation = performance.getEntriesByType('navigation')[0];
                // Performance APIæ¸¬å®šå€¤ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯è¿½åŠ 
                if (navigation && navigation.loadEventEnd && navigation.loadEventStart) {
                    const loadTime = Math.max(0, navigation.loadEventEnd - navigation.loadEventStart);
                    console.log(`Page load time: ${loadTime}ms`);
                } else {
                    console.log('Page load time: measurement unavailable (navigation timing not ready)');
                }
            }
        });

        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç›£è¦–ï¼ˆChromeï¼‰
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.9) {
                    console.warn('High memory usage detected');
                    this.showToast('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé«˜ããªã£ã¦ã„ã¾ã™', 'warning');
                }
            }, 60000); // 1åˆ†ã”ã¨
        }
    }

    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    handleTouchStart(e) {
        if (e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        this.touchStartX = touch.clientX;
        this.touchStartY = touch.clientY;
        this.touchStartTime = Date.now();
    }

    handleTouchMove(e) {
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        if (e.target.closest('.prevent-scroll')) {
            e.preventDefault();
        }
    }

    handleTouchEnd(e) {
        if (e.changedTouches.length !== 1) return;
        
        const touch = e.changedTouches[0];
        const endX = touch.clientX;
        const endY = touch.clientY;
        const endTime = Date.now();
        
        const deltaX = endX - this.touchStartX;
        const deltaY = endY - this.touchStartY;
        const deltaTime = endTime - this.touchStartTime;
        
        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®æ¤œå‡º
        if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 100 && deltaTime < 500) {
            if (deltaX > 0) {
                this.handleSwipeRight();
            } else {
                this.handleSwipeLeft();
            }
        }
        
        // é•·æŠ¼ã—ã®æ¤œå‡º
        if (deltaTime > 500 && Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
            this.handleLongPress(e);
        }
    }

    handleSwipeLeft() {
        // æ¬¡ã®å•é¡Œã¸
        this.navigateQuestion('next');
    }

    handleSwipeRight() {
        // å‰ã®å•é¡Œã¸
        this.navigateQuestion('prev');
    }

    handleLongPress(e) {
        // é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º
        const target = e.target.closest('.answer-option, .question-text');
        if (target) {
            this.showContextMenu(target, e.changedTouches[0]);
        }
    }

    // éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½
    addVoiceControls() {
        const quizContainer = document.querySelector('.quiz-container, .exam-container');
        if (!quizContainer) return;

        // éŸ³å£°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¿½åŠ 
        const voiceControlsHTML = `
            <div class="voice-controls">
                <button id="speakBtn" class="btn btn-sm btn-outline-primary" title="éŸ³å£°èª­ã¿ä¸Šã’ (Space)">
                    ğŸ”Š
                </button>
                <button id="voiceSettingsBtn" class="btn btn-sm btn-outline-secondary" title="éŸ³å£°è¨­å®š">
                    âš™ï¸
                </button>
            </div>
        `;
        
        quizContainer.insertAdjacentHTML('afterbegin', voiceControlsHTML);

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.getElementById('speakBtn')?.addEventListener('click', () => {
            this.toggleSpeech();
        });

        document.getElementById('voiceSettingsBtn')?.addEventListener('click', () => {
            this.showVoiceSettings();
        });
    }

    speakText(text, options = {}) {
        if (!this.voiceSettings.enabled || !this.speechSynthesis) return;

        // ç¾åœ¨ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
        this.speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = options.language || this.voiceSettings.language;
        utterance.rate = options.rate || this.voiceSettings.rate;
        utterance.pitch = options.pitch || this.voiceSettings.pitch;
        utterance.volume = options.volume || this.voiceSettings.volume;

        utterance.onstart = () => {
            const speakBtn = document.getElementById('speakBtn');
            if (speakBtn) {
                speakBtn.innerHTML = 'â¹ï¸';
                speakBtn.classList.add('speaking');
            }
        };

        utterance.onend = () => {
            const speakBtn = document.getElementById('speakBtn');
            if (speakBtn) {
                speakBtn.innerHTML = 'ğŸ”Š';
                speakBtn.classList.remove('speaking');
            }
            this.currentSpeech = null;
        };

        utterance.onerror = (e) => {
            console.error('Speech synthesis error:', e);
            this.showToast('éŸ³å£°èª­ã¿ä¸Šã’ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        };

        this.currentSpeech = utterance;
        this.speechSynthesis.speak(utterance);
    }

    toggleSpeech() {
        if (this.currentSpeech && this.speechSynthesis.speaking) {
            this.speechSynthesis.cancel();
        } else {
            const questionText = this.getQuestionTextForSpeech();
            if (questionText) {
                this.speakText(questionText);
            }
        }
    }

    getQuestionTextForSpeech() {
        const questionElement = document.querySelector('.question-text, .lead');
        if (!questionElement) return null;

        let speechText = `å•é¡Œã€‚${questionElement.textContent}ã€‚`;

        // é¸æŠè‚¢ã®è¿½åŠ 
        const options = document.querySelectorAll('.answer-option .option-text, .form-check-label .option-text');
        options.forEach((option, index) => {
            const letter = ['A', 'B', 'C', 'D'][index];
            speechText += `é¸æŠè‚¢${letter}ã€‚${option.textContent}ã€‚`;
        });

        return speechText;
    }

    // éŸ³å£°èªè­˜ã®è¨­å®š
    setupSpeechRecognition() {
        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        this.recognition = new SpeechRecognition();
        
        this.recognition.lang = 'ja-JP';
        this.recognition.continuous = false;
        this.recognition.interimResults = false;

        this.recognition.onresult = (event) => {
            const result = event.results[0][0].transcript.toLowerCase();
            this.handleVoiceCommand(result);
        };

        this.recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
        };

        // éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã®è¿½åŠ 
        this.addVoiceInputButton();
    }

    handleVoiceCommand(command) {
        // éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†
        if (command.includes('ãˆãƒ¼') || command.includes('a')) {
            this.selectAnswer('A');
        } else if (command.includes('ã³ãƒ¼') || command.includes('b')) {
            this.selectAnswer('B');
        } else if (command.includes('ã—ãƒ¼') || command.includes('c')) {
            this.selectAnswer('C');
        } else if (command.includes('ã§ãƒãƒ¼') || command.includes('d')) {
            this.selectAnswer('D');
        } else if (command.includes('æ¬¡') || command.includes('ã¤ã')) {
            this.navigateQuestion('next');
        } else if (command.includes('å‰') || command.includes('ã¾ãˆ')) {
            this.navigateQuestion('prev');
        } else if (command.includes('èª­ã¿ä¸Šã’') || command.includes('ã‚ˆã¿ã‚ã’')) {
            this.toggleSpeech();
        }
    }

    // IndexedDBã®è¨­å®š
    setupIndexedDB() {
        const request = indexedDB.open('RCCMQuizApp', 1);
        
        request.onerror = () => {
            console.error('IndexedDB opening failed');
        };
        
        request.onsuccess = (event) => {
            this.db = event.target.result;
            console.log('IndexedDB opened successfully');
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢
            if (!db.objectStoreNames.contains('offlineData')) {
                const offlineStore = db.createObjectStore('offlineData', { keyPath: 'id' });
                offlineStore.createIndex('timestamp', 'timestamp', { unique: false });
            }
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢
            if (!db.objectStoreNames.contains('cacheData')) {
                const cacheStore = db.createObjectStore('cacheData', { keyPath: 'key' });
            }
        };
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
    saveOfflineData(data) {
        if (!this.db) return Promise.reject('IndexedDB not available');
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['offlineData'], 'readwrite');
            const store = transaction.objectStore('offlineData');
            
            const request = store.add({
                id: Date.now() + Math.random(),
                data: data,
                timestamp: new Date().toISOString()
            });
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åŒæœŸã®è¨­å®š
    setupBackgroundSync() {
        navigator.serviceWorker.ready.then(registration => {
            return registration.sync.register('sync-study-data');
        }).catch(error => {
            console.error('Background sync registration failed:', error);
        });
    }

    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰æ›´ã®å‡¦ç†
    handleOnlineStateChange(isOnline) {
        const statusIndicator = this.getOrCreateStatusIndicator();
        
        if (isOnline) {
            statusIndicator.className = 'online-status online';
            statusIndicator.innerHTML = 'ğŸ“¡ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
            this.showToast('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ', 'success');
            this.syncOfflineData();
        } else {
            statusIndicator.className = 'online-status offline';
            statusIndicator.innerHTML = 'ğŸš« ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
            this.showToast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸ', 'info');
        }
    }

    getOrCreateStatusIndicator() {
        let indicator = document.getElementById('onlineStatus');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'onlineStatus';
            indicator.className = 'online-status';
            document.body.appendChild(indicator);
        }
        return indicator;
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
    syncOfflineData() {
        if (!this.db || !this.isOnline) return;
        
        const transaction = this.db.transaction(['offlineData'], 'readonly');
        const store = transaction.objectStore('offlineData');
        const request = store.getAll();
        
        request.onsuccess = () => {
            const offlineData = request.result;
            if (offlineData.length === 0) return;
            
            // ã‚µãƒ¼ãƒãƒ¼ã«åŒæœŸ
            fetch('/api/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(offlineData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.clearOfflineData();
                    this.showToast('ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ', 'success');
                }
            })
            .catch(error => {
                console.error('Sync failed:', error);
            });
        };
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    selectAnswer(answer) {
        const option = document.querySelector(`input[value="${answer}"]`);
        if (option) {
            option.checked = true;
            option.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    navigateQuestion(direction) {
        // å•é¡ŒãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿè£…ã¯ãƒšãƒ¼ã‚¸å›ºæœ‰ï¼‰
        const event = new CustomEvent('questionNavigate', { detail: { direction } });
        document.dispatchEvent(event);
    }

    showToast(message, type = 'info') {
        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®è¡¨ç¤º
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    showInstallButton(deferredPrompt) {
        const installBtn = document.createElement('button');
        installBtn.id = 'installBtn';
        installBtn.className = 'btn btn-primary install-btn';
        installBtn.innerHTML = 'ğŸ“± ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
        installBtn.onclick = () => {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(choiceResult => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                deferredPrompt = null;
            });
        };
        
        document.body.appendChild(installBtn);
    }

    hideInstallButton() {
        const installBtn = document.getElementById('installBtn');
        if (installBtn) {
            installBtn.remove();
        }
    }

    showUpdateNotification() {
        if (confirm('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚ä»Šã™ãæ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
            window.location.reload();
        }
    }

    // è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
    saveSettings() {
        localStorage.setItem('rccm_mobile_settings', JSON.stringify({
            voiceSettings: this.voiceSettings
        }));
    }

    loadSettings() {
        const saved = localStorage.getItem('rccm_mobile_settings');
        if (saved) {
            const settings = JSON.parse(saved);
            if (settings.voiceSettings) {
                this.voiceSettings = { ...this.voiceSettings, ...settings.voiceSettings };
            }
        }
    }

    // ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    clearOfflineData() {
        if (!this.db) return;
        
        const transaction = this.db.transaction(['offlineData'], 'readwrite');
        const store = transaction.objectStore('offlineData');
        store.clear();
    }

    addVoiceInputButton() {
        // éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã®å®Ÿè£…ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        const voiceInputBtn = document.createElement('button');
        voiceInputBtn.innerHTML = 'ğŸ¤';
        voiceInputBtn.className = 'btn btn-sm btn-outline-success voice-input-btn';
        voiceInputBtn.onclick = () => {
            if (this.recognition) {
                this.recognition.start();
            }
        };
        
        const voiceControls = document.querySelector('.voice-controls');
        if (voiceControls) {
            voiceControls.appendChild(voiceInputBtn);
        }
    }

    showVoiceSettings() {
        // éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        const modal = document.createElement('div');
        modal.className = 'voice-settings-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <h5>éŸ³å£°è¨­å®š</h5>
                <div class="form-group">
                    <label>èª­ã¿ä¸Šã’é€Ÿåº¦: <span id="rateValue">${this.voiceSettings.rate}</span></label>
                    <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="${this.voiceSettings.rate}">
                </div>
                <div class="form-group">
                    <label>éŸ³é‡: <span id="volumeValue">${this.voiceSettings.volume}</span></label>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="${this.voiceSettings.volume}">
                </div>
                <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">é–‰ã˜ã‚‹</button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('rateSlider').oninput = (e) => {
            this.voiceSettings.rate = parseFloat(e.target.value);
            document.getElementById('rateValue').textContent = e.target.value;
            this.saveSettings();
        };
        
        document.getElementById('volumeSlider').oninput = (e) => {
            this.voiceSettings.volume = parseFloat(e.target.value);
            document.getElementById('volumeValue').textContent = e.target.value;
            this.saveSettings();
        };
    }

    showContextMenu(target, touch) {
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = touch.clientX + 'px';
        menu.style.top = touch.clientY + 'px';
        
        menu.innerHTML = `
            <div class="context-menu-item" onclick="mobileFeatures.speakText('${target.textContent}')">
                ğŸ”Š èª­ã¿ä¸Šã’
            </div>
            <div class="context-menu-item" onclick="mobileFeatures.closeContextMenu()">
                âŒ é–‰ã˜ã‚‹
            </div>
        `;
        
        document.body.appendChild(menu);
        
        // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        setTimeout(() => {
            document.addEventListener('click', () => this.closeContextMenu(), { once: true });
        }, 100);
    }

    closeContextMenu() {
        const menu = document.querySelector('.context-menu');
        if (menu) {
            menu.remove();
        }
    }

    // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®è¨­å®š
    setupAccessibilityFeatures() {
        this.setupKeyboardNavigation();
        this.setupScreenReaderSupport();
    }

    setupKeyboardNavigation() {
        // ã‚¢ãƒ—ãƒªå…¨ä½“ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch (e.key) {
                    case 'h':
                    case 'H':
                        e.preventDefault();
                        window.location.href = '/';
                        break;
                    case 'd':
                    case 'D':
                        e.preventDefault();
                        if (window.toggleTheme) window.toggleTheme();
                        break;
                }
            }
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                window.location.href = '/help';
            }
        });
    }

    setupScreenReaderSupport() {
        // å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿ä¸Šã’æ”¯æ´
        const liveRegion = document.createElement('div');
        liveRegion.setAttribute('aria-live', 'polite');
        liveRegion.setAttribute('aria-atomic', 'true');
        liveRegion.className = 'sr-only';
        liveRegion.id = 'live-announcements';
        document.body.appendChild(liveRegion);
    }

    // ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªã®è¨­å®šï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã«ä¸€æ™‚ç„¡åŠ¹åŒ–ï¼‰
    setupErrorBoundary() {
        console.log('Error boundary setup - DISABLED FOR DEBUGGING');
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ - ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
        /*
        window.addEventListener('error', (e) => {
            this.handleError({
                type: 'javascript',
                message: e.message,
                filename: e.filename,
                line: e.lineno,
                stack: e.error ? e.error.stack : 'ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãªã—'
            });
        });

        // Promise ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.addEventListener('unhandledrejection', (e) => {
            this.handleError({
                type: 'promise',
                message: e.reason ? e.reason.toString() : 'Promise rejection'
            });
        });
        */
    }

    handleError(errorInfo) {
        console.error('Application Error:', errorInfo);
        const userMessage = this.getUserFriendlyErrorMessage(errorInfo);
        this.showToast(userMessage, 'error');
    }

    getUserFriendlyErrorMessage(errorInfo) {
        switch (errorInfo.type) {
            case 'network':
                return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
            case 'javascript':
                return 'ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            default:
                return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
        }
    }
}

// CSS ã‚¹ã‚¿ã‚¤ãƒ«ã®å‹•çš„è¿½åŠ 
const mobileCSS = `
.voice-controls {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1000;
    display: flex;
    gap: 5px;
}

.online-status {
    position: fixed;
    top: 50px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    z-index: 1000;
}

.online-status.online {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.online-status.offline {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.install-btn {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
}

.toast-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    border-radius: 5px;
    color: white;
    z-index: 1001;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.toast-notification.show {
    opacity: 1;
}

.toast-info { background: #17a2b8; }
.toast-success { background: #28a745; }
.toast-warning { background: #ffc107; color: #212529; }
.toast-error { background: #dc3545; }

.context-menu {
    position: fixed;
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1002;
}

.context-menu-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.context-menu-item:last-child {
    border-bottom: none;
}

.context-menu-item:hover {
    background: #f8f9fa;
}

.voice-settings-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1003;
}

.voice-settings-modal .modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
}

.form-group input[type="range"] {
    width: 100%;
}

@media (max-width: 768px) {
    .voice-controls {
        top: 5px;
        right: 5px;
    }
    
    .online-status {
        top: 45px;
        right: 5px;
        font-size: 11px;
    }
}
`;

// CSSã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
const styleSheet = document.createElement('style');
styleSheet.textContent = mobileCSS;
document.head.appendChild(styleSheet);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
let mobileFeatures;

// DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    mobileFeatures = new MobileFeatures();
});

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç’°å¢ƒç”¨ï¼‰
if (typeof module !== 'undefined' && module.exports) {
    module.exports = MobileFeatures;
}