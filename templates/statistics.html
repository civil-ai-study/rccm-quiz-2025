{% extends 'base.html' %}
{% block title %}å›ç­”çµæœåˆ†æ | RCCMè©¦é¨“å•é¡Œé›†{% endblock %}
{% block content %}
<div class="container py-4">
    <h2 class="mb-4">ç·åˆå›ç­”çµæœåˆ†æ</h2>
    <!-- å…¨ä½“é€²æ—ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
    <div class="mb-4">
        <label for="progressBar" class="form-label">å…¨ä½“æ­£ç­”ç‡</label>
        <div class="progress" style="height: 30px;">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: {{ '%.1f' % (overall_stats.total_accuracy|default(0.0)) }}%;" aria-valuenow="{{ '%.1f' % (overall_stats.total_accuracy|default(0.0)) }}" aria-valuemin="0" aria-valuemax="100">
                {{ '%.1f' % (overall_stats.total_accuracy|default(0.0)) }}%
            </div>
        </div>
    </div>
    <!-- å…±é€šãƒ»å°‚é–€åˆ¥æ­£ç­”ç‡ æ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ -->
    <div class="card mb-3">
        <div class="card-header">å…±é€šãƒ»å°‚é–€åˆ¥å›ç­”çµæœ</div>
        <div class="card-body">
            <canvas id="basicSpecialtyChart" height="120"></canvas>
            <p class="text-muted mt-2 mb-0">4-1åŸºç¤ç§‘ç›®ï¼ˆå…±é€šï¼‰ã¨4-2å°‚é–€ç§‘ç›®ã®æ­£ç­”ç‡ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
        </div>
    </div>
    <div class="card mb-3">
        <div class="card-header">å…¨ä½“ã‚µãƒãƒªãƒ¼</div>
        <div class="card-body">
            <p><strong>å®Ÿæ–½ã—ãŸå•é¡Œæ•°:</strong> {{ overall_stats.total_questions | default('ãƒ‡ãƒ¼ã‚¿ãªã—') }}</p>
            <p><strong>å…¨å•é¡Œã®ç´¯è¨ˆæ­£ç­”ç‡:</strong> {{ '%.1f' % (overall_stats.total_accuracy|default(0.0)) }}%</p>
            <p><strong>å¹³å‡è§£ç­”æ™‚é–“:</strong> {{ overall_stats.average_time_per_question | default('ãƒ‡ãƒ¼ã‚¿ãªã—') }} ç§’/å•</p>
            {% set accuracy = overall_stats.total_accuracy|default(0.0) %}
            <div class="mt-2">
                {% if accuracy >= 90 %}
                    <span class="badge bg-success">ç´ æ™´ã‚‰ã—ã„æˆç¸¾ã§ã™ï¼ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</span>
                {% elif accuracy >= 80 %}
                    <span class="badge bg-primary">ã‚ã¨å°‘ã—ã§90%é”æˆï¼å¼•ãç¶šãé ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</span>
                {% elif accuracy >= 60 %}
                    <span class="badge bg-warning text-dark">è‹¦æ‰‹åˆ†é‡ã‚’é‡ç‚¹çš„ã«å¾©ç¿’ã—ã¾ã—ã‚‡ã†ã€‚</span>
                {% else %}
                    <span class="badge bg-danger">ã¾ãšã¯åŸºç¤ã‚’ã—ã£ã‹ã‚Šå›ºã‚ã¾ã—ã‚‡ã†ï¼</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card mb-3">
        <div class="card-header">å…±é€šãƒ»å°‚é–€åˆ¥è©³ç´°å›ç­”çµæœ</div>
        <div class="card-body p-0">
            {% if basic_specialty_details %}
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered mb-0" style="font-size:0.92em;">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 150px;">ç§‘ç›®åŒºåˆ†</th>
                            <th style="width: 60px;">è§£ç­”æ•°</th>
                            <th style="width: 60px;">æ­£ç­”æ•°</th>
                            <th style="width: 70px;">æ­£ç­”ç‡(%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>4-1 åŸºç¤ç§‘ç›®ï¼ˆå…±é€šï¼‰</td>
                            <td>{{ basic_specialty_details.basic.total_answered }}</td>
                            <td>{{ basic_specialty_details.basic.correct_count }}</td>
                            <td>{{ '%.1f' % (basic_specialty_details.basic.accuracy|default(0.0)) }}</td>
                        </tr>
                        <tr>
                            <td>4-2 å°‚é–€ç§‘ç›®</td>
                            <td>{{ basic_specialty_details.specialty.total_answered }}</td>
                            <td>{{ basic_specialty_details.specialty.correct_count }}</td>
                            <td>{{ '%.1f' % (basic_specialty_details.specialty.accuracy|default(0.0)) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="m-3">å…±é€šãƒ»å°‚é–€åˆ¥çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">æ­£ç­”ç‡æ¨ç§»ï¼ˆæ—¥ã”ã¨ï¼‰</div>
        <div class="card-body">
            <canvas id="accuracyTrendChart" height="120"></canvas>
            <p class="text-muted mt-2 mb-0">æ—¥ã”ã¨ã®æ­£ç­”ç‡æ¨ç§»ã‚’ç¸¦æ£’ã‚°ãƒ©ãƒ•ã§è¡¨ç¤ºã—ã¾ã™ã€‚</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">ç›´è¿‘ã®å•é¡Œå±¥æ­´</div>
        <div class="card-body">
            {% if quiz_history %}
                <ul class="list-group">
                {% for quiz in quiz_history %}
                    <li class="list-group-item">
                        å®Ÿæ–½æ—¥æ™‚: {{ quiz.date }}, åˆ†é‡: {{ quiz.category | default('å…¨ä½“') }},
                        æ­£ç­”: {{ 'â—‹' if quiz.is_correct else 'Ã—' }},
                        è§£ç­”æ™‚é–“: {{ quiz.elapsed | default('-') }} ç§’
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>å•é¡Œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>
    </div>

    <form method="post" action="/reset" onsubmit="return confirm('æœ¬å½“ã«å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚');">
      <button type="submit" class="btn btn-danger mt-3">å…¨å­¦ç¿’å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </form>

    <div class="mt-4">
        <a href="{{ url_for('department_statistics') }}" class="btn btn-primary mr-3">
            ğŸ“Š éƒ¨é–€åˆ¥è©³ç´°çµ±è¨ˆ
        </a>
        <a href="/" class="btn btn-secondary">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// å…±é€šãƒ»å°‚é–€åˆ¥æ­£ç­”ç‡ãƒ‡ãƒ¼ã‚¿
const basicSpecialtyData = {{ basic_specialty_details | tojson | safe }};
// æ¨ªæ£’ã‚°ãƒ©ãƒ•
const ctxBar = document.getElementById('basicSpecialtyChart').getContext('2d');
const barChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
        labels: ['4-1 åŸºç¤ç§‘ç›®ï¼ˆå…±é€šï¼‰', '4-2 å°‚é–€ç§‘ç›®'],
        datasets: [{
            label: 'æ­£ç­”ç‡ï¼ˆ%ï¼‰',
            data: basicSpecialtyData ? [
                basicSpecialtyData.basic ? basicSpecialtyData.basic.accuracy : 0,
                basicSpecialtyData.specialty ? basicSpecialtyData.specialty.accuracy : 0
            ] : [0, 0],
            backgroundColor: ['#2196F3', '#4CAF50'],
            borderWidth: 1,
            barThickness: 18
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
            legend: { display: false },
            title: { display: false },
            tooltip: {
                enabled: true,
                callbacks: {
                    label: function(context) {
                        return context.parsed.x + '%';
                    }
                }
            }
        },
        scales: {
            x: {
                min: 0,
                max: 100,
                title: { display: true, text: 'æ­£ç­”ç‡ï¼ˆ%ï¼‰' },
                ticks: { stepSize: 10, font: { size: 10 } }
            },
            y: {
                title: { display: false },
                ticks: { font: { size: 12 } }
            }
        },
        animation: {
            duration: 600,
            easing: 'easeOutQuart'
        }
    }
});

// æˆç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆæ—¥ã”ã¨ã®æ­£ç­”ç‡%ï¼‰
const dailyAccuracyList = {{ daily_accuracy_list|tojson|safe }};
const trendLabels = dailyAccuracyList.map(d => d.date);
const trendData = dailyAccuracyList.map(d => d.accuracy);
const ctxTrend = document.getElementById('accuracyTrendChart').getContext('2d');
const trendChart = new Chart(ctxTrend, {
    type: 'bar',
    data: {
        labels: trendLabels,
        datasets: [{
            label: 'æ­£ç­”ç‡ï¼ˆ%ï¼‰',
            data: trendData,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            title: { display: false }
        },
        scales: {
            y: {
                min: 0,
                max: 100,
                title: { display: true, text: 'æ­£ç­”ç‡ï¼ˆ%ï¼‰' },
                ticks: { stepSize: 20 }
            }
        },
        animation: {
            duration: 600,
            easing: 'easeOutQuart'
        }
    }
});
</script>
{% endblock %} 