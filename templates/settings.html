{% extends 'base.html' %}
{% block title %}設定 | RCCM試験問題集{% endblock %}
{% block content %}
<div class="container my-4">
  <!-- ページヘッダー -->
  <div class="text-center mb-4">
    <div class="d-flex align-items-center justify-content-center mb-3">
      <a href="/" class="btn btn-outline-secondary me-3">
        ⬅️ ホームに戻る
      </a>
      <h1 class="mb-0">
        ⚙️ 設定
      </h1>
    </div>
    <p class="text-muted">学習設定をカスタマイズできます</p>
  </div>

  <!-- フラッシュメッセージ -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
          {% if category == 'success' %}✅{% else %}⚠️{% endif %}
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- 設定フォーム -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card border-primary">
        <div class="card-header text-white text-center" style="background-color: var(--primary-color)">
          <h5 class="mb-0">🎯 問題数設定</h5>
        </div>
        <div class="card-body">
          <form method="POST">
            <!-- 問題数選択 -->
            <div class="mb-4">
              <label class="form-label"><strong>1セッションあたりの問題数</strong></label>
              <p class="text-muted small">学習セッションで出題される問題数を選択してください</p>
              
              <div class="row g-3">
                {% for option in available_options %}
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="questions_per_session" 
                           value="{{ option }}" id="questions_{{ option }}"
                           {% if current_questions == option %}checked{% endif %}>
                    <label class="form-check-label w-100" for="questions_{{ option }}">
                      <div class="card h-100 {% if current_questions == option %}border-success bg-light{% else %}border-secondary{% endif %}">
                        <div class="card-body text-center">
                          <h4 class="text-primary">{{ option }}問</h4>
                          <div class="mt-2">
                            {% if option == 10 %}
                              <small class="text-muted">標準・短時間学習</small>
                              <div>🕰️ 約15-20分</div>
                            {% elif option == 20 %}
                              <small class="text-muted">しっかり学習</small>
                              <div>🕰️ 約30-40分</div>
                            {% elif option == 30 %}
                              <small class="text-muted">集中特訓</small>
                              <div>🕰️ 約45-60分</div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>

            <!-- 現在の設定表示 -->
            <div class="alert alert-info mb-4">
              ℹ️
              <strong>現在の設定:</strong> {{ current_questions }}問/セッション
            </div>

            <!-- 注意事項 -->
            <div class="alert alert-warning mb-4">
              <h6>⚠️ 設定変更について</h6>
              <ul class="mb-0">
                <li>設定変更は次回の学習セッションから適用されます</li>
                <li>現在進行中のセッションには影響しません</li>
                <li>問題数が多いほど、より幅広い範囲の学習ができます</li>
                <li>短時間で集中したい場合は10問、じっくり学習したい場合は20-30問がおすすめです</li>
              </ul>
            </div>

            <!-- 送信ボタン -->
            <div class="text-center">
              <button type="submit" class="btn btn-success btn-lg px-5">
                💾 設定を保存
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 表示設定 -->
  <div class="row justify-content-center mt-4">
    <div class="col-md-8">
      <div class="card border-primary">
        <div class="card-header text-white text-center" style="background-color: var(--primary-color)">
          <h5 class="mb-0">👁️ 表示設定</h5>
        </div>
        <div class="card-body">
          <!-- 文字サイズ選択 -->
          <div class="mb-4">
            <label class="form-label"><strong>文字サイズ</strong></label>
            <p class="text-muted small">読みやすさに合わせて文字サイズを選択してください</p>

            <div class="btn-group w-100 font-size-selector" role="group" aria-label="文字サイズ選択">
              <input type="radio" class="btn-check" name="fontSize" id="fs-standard" value="standard" autocomplete="off">
              <label class="btn btn-outline-primary" for="fs-standard">
                <div class="text-center">
                  <div style="font-size: 16px;">A</div>
                  <small>標準</small>
                </div>
              </label>

              <input type="radio" class="btn-check" name="fontSize" id="fs-large" value="large" autocomplete="off">
              <label class="btn btn-outline-primary" for="fs-large">
                <div class="text-center">
                  <div style="font-size: 20px;">A</div>
                  <small>大きめ</small>
                </div>
              </label>

              <input type="radio" class="btn-check" name="fontSize" id="fs-extra-large" value="extra-large" autocomplete="off">
              <label class="btn btn-outline-primary" for="fs-extra-large">
                <div class="text-center">
                  <div style="font-size: 24px;">A</div>
                  <small>特大</small>
                </div>
              </label>
            </div>

            <div class="alert alert-info mt-3 mb-0">
              ℹ️ 設定した文字サイズは全てのページに適用されます
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- その他の設定（将来拡張用） -->
  <div class="row justify-content-center mt-4">
    <div class="col-md-8">
      <div class="card border-light">
        <div class="card-header bg-light">
          <h6 class="mb-0">🔧 その他の設定（準備中）</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-4">
              <div class="p-3 future-feature">
                🔔
                <div><strong>通知設定</strong></div>
                <small>学習リマインダー</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 future-feature">
                📊
                <div><strong>統計設定</strong></div>
                <small>詳細レポート表示</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 future-feature">
                🎯
                <div><strong>学習プラン</strong></div>
                <small>個別最適化</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.form-check-label .card {
  cursor: pointer;
  transition: all 0.3s ease;
}

.form-check-label .card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.form-check-input:checked + .form-check-label .card {
  border-color: var(--success-color) !important;
  background-color: #e8f5e8 !important;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.future-feature {
  opacity: 0.6;
  border: 1px dashed #ccc;
  border-radius: 8px;
  background-color: #f8f9fa;
}

[data-theme="dark"] .future-feature {
  background-color: var(--card-bg);
  border-color: var(--border-color);
}

[data-theme="dark"] .form-check-input:checked + .form-check-label .card {
  background-color: #1e3c2f !important;
  border-color: var(--success-color) !important;
}
</style>

<script>
// ラジオボタンのクリック処理を改善
document.querySelectorAll('.form-check-label').forEach(label => {
  label.addEventListener('click', function() {
    // 少し遅延をつけてスタイル更新
    setTimeout(() => {
      document.querySelectorAll('.form-check-label .card').forEach(card => {
        card.classList.remove('border-success', 'bg-light');
        card.classList.add('border-secondary');
      });

      const checkedInput = document.querySelector('input[name="questions_per_session"]:checked');
      if (checkedInput) {
        const checkedCard = checkedInput.nextElementSibling.querySelector('.card');
        checkedCard.classList.remove('border-secondary');
        checkedCard.classList.add('border-success', 'bg-light');
      }
    }, 10);
  });
});

// 文字サイズ切り替え機能
document.querySelectorAll('[name="fontSize"]').forEach(radio => {
  radio.addEventListener('change', (e) => {
    const size = e.target.value;
    document.body.setAttribute('data-font-size', size);
    localStorage.setItem('fontSize', size);

    // 変更を視覚的にフィードバック
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
      ✅ 文字サイズを「${size === 'standard' ? '標準' : size === 'large' ? '大きめ' : '特大'}」に変更しました
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
  });
});

// ページロード時に設定を復元
window.addEventListener('DOMContentLoaded', () => {
  const savedSize = localStorage.getItem('fontSize') || 'standard';
  document.body.setAttribute('data-font-size', savedSize);
  const savedRadio = document.getElementById('fs-' + savedSize);
  if (savedRadio) {
    savedRadio.checked = true;
  }
});
</script>
{% endblock %}