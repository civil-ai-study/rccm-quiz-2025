{% extends "base.html" %}

{% block title %}å­¦ç¿’åŠ¹ç‡æœ€é©åŒ–{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        ğŸ“ˆ å­¦ç¿’åŠ¹ç‡æœ€é©åŒ–ã‚¨ãƒ³ã‚¸ãƒ³
                    </h3>
                    <p class="mb-0 small">å€‹äººã®å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒã‚¤ã‚ªãƒªã‚ºãƒ åˆ†æã«ã‚ˆã‚‹æœ€é©åŒ–</p>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        ğŸ’¡
                        ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€æœ€ã‚‚åŠ¹ç‡çš„ãªå­¦ç¿’æ™‚é–“ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ææ¡ˆã—ã¾ã™ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æçµæœ -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ğŸ•°ï¸ ã‚ãªãŸã®å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>å­¦ç¿’ã‚¿ã‚¤ãƒ—</h6>
                            <span class="badge badge-primary badge-lg">
                                {% if learning_pattern.learning_type == 'morning_intensive' %}æœå‹é›†ä¸­å­¦ç¿’
                                {% elif learning_pattern.learning_type == 'morning_light' %}æœå‹è»½å­¦ç¿’
                                {% elif learning_pattern.learning_type == 'evening_intensive' %}å¤œå‹é›†ä¸­å­¦ç¿’
                                {% elif learning_pattern.learning_type == 'evening_light' %}å¤œå‹è»½å­¦ç¿’
                                {% elif learning_pattern.learning_type == 'flexible_intensive' %}ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«é›†ä¸­
                                {% elif learning_pattern.learning_type == 'flexible_light' %}ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«è»½å­¦ç¿’
                                {% else %}æœªåˆ†æ{% endif %}
                            </span>
                            
                            <h6 class="mt-3">åˆ†æä¿¡é ¼åº¦</h6>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: {{ (learning_pattern.analysis_confidence * 100)|round|int }}%"></div>
                            </div>
                            <small class="text-muted">{{ (learning_pattern.analysis_confidence * 100)|round|int }}%</small>
                        </div>
                        <div class="col-md-6">
                            <h6>å­¦ç¿’ç¶™ç¶šæ€§</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-info" style="width: {{ (learning_pattern.consistency.consistency_score * 100)|round|int }}%"></div>
                            </div>
                            <small class="text-muted">ã‚¹ã‚³ã‚¢: {{ (learning_pattern.consistency.consistency_score * 100)|round|int }}%</small>
                            
                            <div class="mt-2">
                                <div class="d-flex justify-content-between">
                                    <span>å­¦ç¿’æ—¥æ•°:</span>
                                    <strong>{{ learning_pattern.consistency.study_days }}æ—¥</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>æœ€é•·ã‚¹ãƒˆãƒªãƒ¼ã‚¯:</span>
                                    <strong>{{ learning_pattern.consistency.max_streak }}æ—¥</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">ğŸ•°ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æ</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³é•·:</span>
                        <strong>{{ learning_pattern.session_analysis.avg_session_length|round|int }}åˆ†</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>æ¨å¥¨ã‚»ãƒƒã‚·ãƒ§ãƒ³é•·:</span>
                        <strong>{{ learning_pattern.session_analysis.optimal_session_length }}åˆ†</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°:</span>
                        <strong>{{ learning_pattern.session_analysis.session_count }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™‚é–“å¸¯åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
    {% if learning_pattern.hourly_performance %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“Š æ™‚é–“å¸¯åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for hour in range(6, 24) %}
                        {% set hour_data = learning_pattern.hourly_performance.get(hour) %}
                        {% if hour_data %}
                        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">
                            <div class="card border-light text-center">
                                <div class="card-body p-2">
                                    <h6 class="card-title">{{ hour }}æ™‚</h6>
                                    <div class="progress progress-sm mb-1">
                                        <div class="progress-bar 
                                            {% if hour_data.efficiency_score >= 0.8 %}bg-success
                                            {% elif hour_data.efficiency_score >= 0.6 %}bg-warning
                                            {% else %}bg-secondary{% endif %}" 
                                            style="width: {{ (hour_data.efficiency_score * 100)|round|int }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ (hour_data.efficiency_score * 100)|round|int }}%</small>
                                    <br>
                                    <small class="text-muted">{{ hour_data.sessions }}å›</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æœ€é©æ™‚é–“æ¨å¥¨ -->
    {% if learning_pattern.optimal_times %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">â­ ã‚ãªãŸã®æœ€é©å­¦ç¿’æ™‚é–“</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for optimal_time in learning_pattern.optimal_times[:3] %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h4 class="text-success">{{ optimal_time.hour }}:00</h4>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" style="width: {{ (optimal_time.efficiency_score * 100)|round|int }}%"></div>
                                    </div>
                                    <small class="text-muted">
                                        åŠ¹ç‡åº¦: {{ (optimal_time.efficiency_score * 100)|round|int }}%<br>
                                        ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: {{ optimal_time.sessions }}å›
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ä»Šæ—¥ã®æ¨å¥¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    {% if optimization_data.optimal_schedule %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ğŸ“… ä»Šæ—¥ã®æ¨å¥¨å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h5>
                </div>
                <div class="card-body">
                    {% if optimization_data.optimal_schedule.recommended_sessions %}
                    <div class="row">
                        {% for session in optimization_data.optimal_schedule.recommended_sessions %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        ğŸ•°ï¸ {{ session.start_time }}
                                    </h6>
                                    <p class="card-text">
                                        <strong>{{ session.duration_minutes }}åˆ†é–“</strong><br>
                                        åŠ¹ç‡äºˆæ¸¬: {{ (session.efficiency_score * 100)|round|int }}%
                                    </p>
                                    {% if session.recommended_activities %}
                                    <small class="text-muted">
                                        æ¨å¥¨æ´»å‹•:
                                        {% for activity in session.recommended_activities %}
                                        <span class="badge badge-light">{{ activity }}</span>
                                        {% endfor %}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="alert alert-light">
                        <strong>ç·å­¦ç¿’æ™‚é–“: {{ optimization_data.optimal_schedule.total_daily_minutes }}åˆ†</strong>
                        {% if optimization_data.optimal_schedule.peak_efficiency_period %}
                        <br><small class="text-muted">
                            ãƒ”ãƒ¼ã‚¯åŠ¹ç‡æ™‚é–“å¸¯: {{ optimization_data.optimal_schedule.peak_efficiency_period.start_hour }}:00
                        </small>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€å€‹åˆ¥æ¨å¥¨ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚å­¦ç¿’ã‚’ç¶šã‘ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ã—ã¦ãã ã•ã„ã€‚
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ãƒã‚¤ã‚ªãƒªã‚ºãƒ åˆ†æ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">ğŸ’“ ãƒã‚¤ã‚ªãƒªã‚ºãƒ åˆ†æ</h5>
                </div>
                <div class="card-body">
                    <div id="biorhythm-section">
                        {% if optimization_data.biorhythm_scores %}
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>èº«ä½“ãƒªã‚ºãƒ </h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-danger" style="width: {{ ((optimization_data.biorhythm_scores.physical + 1) * 50)|round|int }}%"></div>
                                    </div>
                                    <small>{{ (optimization_data.biorhythm_scores.physical * 100)|round|int }}%</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>æ„Ÿæƒ…ãƒªã‚ºãƒ </h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-warning" style="width: {{ ((optimization_data.biorhythm_scores.emotional + 1) * 50)|round|int }}%"></div>
                                    </div>
                                    <small>{{ (optimization_data.biorhythm_scores.emotional * 100)|round|int }}%</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>çŸ¥æ€§ãƒªã‚ºãƒ </h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-info" style="width: {{ ((optimization_data.biorhythm_scores.intellectual + 1) * 50)|round|int }}%"></div>
                                    </div>
                                    <small>{{ (optimization_data.biorhythm_scores.intellectual * 100)|round|int }}%</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>ç·åˆã‚¹ã‚³ã‚¢</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" style="width: {{ ((optimization_data.biorhythm_scores.composite + 1) * 50)|round|int }}%"></div>
                                    </div>
                                    <small>{{ (optimization_data.biorhythm_scores.composite * 100)|round|int }}%</small>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <p>ãƒã‚¤ã‚ªãƒªã‚ºãƒ åˆ†æã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ç”Ÿå¹´æœˆæ—¥ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                            <div class="form-group">
                                <label for="birthDate">ç”Ÿå¹´æœˆæ—¥:</label>
                                <input type="date" class="form-control" id="birthDate" style="max-width: 200px;">
                                <button class="btn btn-primary mt-2" onclick="setBirthDate()">è¨­å®š</button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŠ¹ç‡è¿½è·¡ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">â±ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŠ¹ç‡è¿½è·¡</h5>
                </div>
                <div class="card-body">
                    <div id="realtime-tracking">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>ç¾åœ¨ã®åŠ¹ç‡</h6>
                                    <h4 id="current-efficiency" class="text-primary">--</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>ç–²åŠ´åº¦</h6>
                                    <h4 id="fatigue-level" class="text-warning">--</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“</h6>
                                    <h4 id="session-duration" class="text-info">--</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h6>æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>
                                    <h4 id="recommended-action" class="text-success">--</h4>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-success" onclick="startRealtimeTracking()">
                                â–¶ï¸ è¿½è·¡é–‹å§‹
                            </button>
                            <button class="btn btn-secondary" onclick="stopRealtimeTracking()">
                                â¹ï¸ è¿½è·¡åœæ­¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    â¬…ï¸ ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </a>
                <div>
                    <a href="{{ url_for('learner_insights') }}" class="btn btn-outline-info">
                        ğŸ“ å­¦ç¿’è€…ãƒ¬ãƒ™ãƒ«åˆ†æ
                    </a>
                    <a href="{{ url_for('adaptive_quiz') }}" class="btn btn-outline-success">
                        ğŸ§  æœ€é©åŒ–å­¦ç¿’é–‹å§‹
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
let realtimeTrackingInterval;
let sessionStartTime;

// ãƒã‚¤ã‚ªãƒªã‚ºãƒ è¨­å®š
function setBirthDate() {
    const birthDate = document.getElementById('birthDate').value;
    if (!birthDate) {
        alert('ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    fetch('/api/learning/biorhythm', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            birth_date: birthDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãƒã‚¤ã‚ªãƒªã‚ºãƒ ã‚’è¡¨ç¤º
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        }
    })
    .catch(error => {
        // Biorhythm setting error (production mode)
        alert('è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡é–‹å§‹
function startRealtimeTracking() {
    sessionStartTime = new Date().toISOString();
    
    realtimeTrackingInterval = setInterval(function() {
        fetch('/api/learning/realtime_tracking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_start_time: sessionStartTime,
                question_count: 0
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateRealtimeDisplay(data.tracking_data);
            }
        })
        .catch(error => {
            // Real-time tracking error (production mode)
        });
    }, 5000); // 5ç§’ã”ã¨ã«æ›´æ–°
    
    document.querySelector('button[onclick="startRealtimeTracking()"]').disabled = true;
    document.querySelector('button[onclick="stopRealtimeTracking()"]').disabled = false;
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡åœæ­¢
function stopRealtimeTracking() {
    if (realtimeTrackingInterval) {
        clearInterval(realtimeTrackingInterval);
        realtimeTrackingInterval = null;
    }
    
    document.querySelector('button[onclick="startRealtimeTracking()"]').disabled = false;
    document.querySelector('button[onclick="stopRealtimeTracking()"]').disabled = true;
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ›´æ–°
function updateRealtimeDisplay(trackingData) {
    document.getElementById('current-efficiency').textContent = 
        Math.round(trackingData.current_efficiency * 100) + '%';
    
    document.getElementById('fatigue-level').textContent = 
        Math.round(trackingData.fatigue_level * 100) + '%';
    
    document.getElementById('session-duration').textContent = 
        Math.round(trackingData.session_duration) + 'åˆ†';
    
    document.getElementById('recommended-action').textContent = 
        trackingData.should_continue ? 'ç¶™ç¶š' : 'ä¼‘æ†©';
    
    // è‰²ã®èª¿æ•´
    const efficiencyElement = document.getElementById('current-efficiency');
    if (trackingData.current_efficiency >= 0.7) {
        efficiencyElement.className = 'text-success';
    } else if (trackingData.current_efficiency >= 0.5) {
        efficiencyElement.className = 'text-warning';
    } else {
        efficiencyElement.className = 'text-danger';
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹
    document.querySelector('button[onclick="stopRealtimeTracking()"]').disabled = true;
});
</script>
{% endblock %}