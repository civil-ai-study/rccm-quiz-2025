<!DOCTYPE html>
<html lang="ja" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="description" content="RCCMË©¶È®ìÂØæÁ≠ñ - AIÊê≠Ëºâ„ÅÆÂ≠¶Áøí„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅßÂäπÁéáÁöÑ„Å™Ë≥áÊ†ºÂèñÂæó„ÇíÊîØÊè¥">
    <meta name="keywords" content="RCCM, Ë©¶È®ìÂØæÁ≠ñ, Âª∫Ë®≠„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà, Â≠¶Áøí, AI">
    <meta name="author" content="RCCM Quiz App">
    
    <!-- Enhanced Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="{% block og_title %}RCCMË©¶È®ìÂïèÈ°åÈõÜ - AIÂ≠¶Áøí„Ç¢„Ç∑„Çπ„Çø„É≥„Éà{% endblock %}">
    <meta property="og:description" content="{% block og_description %}AIÊê≠Ëºâ„ÅÆRCCMË©¶È®ìÂØæÁ≠ñ„Ç¢„Éó„É™„ÄÇÂäπÁéáÁöÑ„Å™Â≠¶Áøí„ÅßË≥áÊ†ºÂèñÂæó„Çí„Çµ„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:image" content="{{ url_for('static', filename='icons/icon-512x512.png') }}">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}RCCMË©¶È®ìÂïèÈ°åÈõÜ - AIÂ≠¶Áøí„Ç¢„Ç∑„Çπ„Çø„É≥„Éà{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}AIÊê≠Ëºâ„ÅÆRCCMË©¶È®ìÂØæÁ≠ñ„Ç¢„Éó„É™{% endblock %}">
    
    <!-- Enhanced Mobile Configuration -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="RCCMÂïèÈ°åÈõÜ">
    
    <!-- Favicon Enhanced -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32x32.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-144x144.png') }}">
    
    <title>{% block title %}RCCMË©¶È®ìÂïèÈ°åÈõÜ - AIÂ≠¶Áøí„Ç¢„Ç∑„Çπ„Çø„É≥„Éà{% endblock %}</title>
    
    <!-- Enhanced CSS Framework -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
          crossorigin="anonymous">
    
    <!-- FontAwesome removed to prevent ‚ñ° character display issues -->
    
    <!-- Google Fonts - Inter for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Enhanced UI Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced_ui.css') }}">
    
    <!-- Existing Styles (for backward compatibility) -->
    {% block styles %}{% endblock %}
    
    <!-- Enhanced Accessibility Styles -->
    <style>
        /* Accessibility enhancements */
        .font-size-small { font-size: 0.875rem; }
        .font-size-normal { font-size: 1rem; }
        .font-size-large { font-size: 1.125rem; }
        .font-size-xl { font-size: 1.25rem; }
        
        .high-contrast {
            --primary-color: #000000;
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #000000;
        }
        
        .high-contrast .enhanced-card,
        .high-contrast .option-enhanced {
            border: 2px solid var(--border-color) !important;
            background: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        
        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        /* Focus indicators */
        .focus-visible,
        *:focus-visible {
            outline: 3px solid #2563eb !important;
            outline-offset: 2px !important;
        }

        /* Accessibility Modes - High Contrast */
        .high-contrast-mode {
            background: #000 !important;
            color: #fff !important;
        }

        .high-contrast-mode .card,
        .high-contrast-mode .alert,
        .high-contrast-mode .learning-card,
        .high-contrast-mode .option-item {
            background: #1a1a1a !important;
            border: 2px solid #fff !important;
            color: #fff !important;
        }

        .high-contrast-mode .btn {
            border: 2px solid #fff !important;
            font-weight: 700 !important;
        }

        .high-contrast-mode a {
            color: #4da6ff !important;
            text-decoration: underline !important;
        }

        /* Accessibility Modes - Outdoor Mode */
        .outdoor-mode {
            background: #fff !important;
        }

        .outdoor-mode * {
            font-weight: 600 !important;
            text-shadow: 0 0 1px rgba(0,0,0,0.3) !important;
        }

        .outdoor-mode .card,
        .outdoor-mode .alert,
        .outdoor-mode .learning-card,
        .outdoor-mode .option-item {
            border: 3px solid #333 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
        }

        .outdoor-mode .btn {
            border: 3px solid #333 !important;
            font-size: 1.1rem !important;
            padding: 12px 20px !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.25) !important;
        }

        .outdoor-mode .learning-card h3,
        .outdoor-mode .alert h5,
        .outdoor-mode h1, .outdoor-mode h2, .outdoor-mode h3 {
            font-size: 1.3rem !important;
            color: #000 !important;
        }

        .outdoor-mode .option-text {
            color: #000 !important;
            font-weight: 700 !important;
        }

        .outdoor-mode .badge {
            border: 2px solid #000 !important;
        }

        /* Skip to content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #2563eb;
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1000;
        }
        
        .skip-link:focus {
            top: 6px;
        }
    </style>
    
    <!-- Performance and Security -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="{{ url_for('static', filename='css/enhanced_ui.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='js/enhanced_interactions.js') }}" as="script">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "EducationalApplication",
        "name": "RCCMË©¶È®ìÂïèÈ°åÈõÜ",
        "description": "AIÊê≠Ëºâ„ÅÆRCCMË©¶È®ìÂØæÁ≠ñ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "JPY"
        },
        "author": {
            "@type": "Organization",
            "name": "RCCM Quiz App"
        }
    }
    </script>
</head>

<body class="d-flex flex-column h-100">
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link">„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å´„Çπ„Ç≠„ÉÉ„Éó</a>
    
    <!-- Enhanced Navigation -->
    <nav class="nav-enhanced" role="navigation" aria-label="„É°„Ç§„É≥„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥">
        <div class="nav-content">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('index') }}" class="navbar-brand text-decoration-none">
                    üéì
                    <span class="fw-bold text-dark">RCCMÂïèÈ°åÈõÜ</span>
                </a>
                {% block nav_brand_extra %}{% endblock %}
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <!-- Accessibility Controls -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                            type="button" 
                            id="accessibilityMenu" 
                            data-bs-toggle="dropdown" 
                            aria-expanded="false"
                            aria-label="„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ë®≠ÂÆö">
                        ‚ôø
                        <span class="d-none d-md-inline ms-1">Ë®≠ÂÆö</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accessibilityMenu">
                        <li><h6 class="dropdown-header">„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£</h6></li>
                        <li>
                            <button class="dropdown-item" onclick="toggleHighContrast()">
                                üåó „Éè„Ç§„Ç≥„É≥„Éà„É©„Çπ„Éà
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">ÊñáÂ≠ó„Çµ„Ç§„Ç∫</h6></li>
                        <li>
                            <button class="dropdown-item" onclick="setFontSize('small')">
                                üìè Â∞è
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setFontSize('normal')">
                                üìè Ê®ôÊ∫ñ
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setFontSize('large')">
                                üìè Â§ß
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" onclick="setFontSize('xl')">
                                üìè ÁâπÂ§ß
                            </button>
                        </li>
                    </ul>
                </div>
                
                {% block nav_extra %}{% endblock %}
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-shrink-0" id="main-content" role="main">
        {% block content %}{% endblock %}
    </main>

    <!-- Enhanced Footer -->
    <footer class="footer mt-auto py-4 bg-light border-top">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center text-muted">
                        üéì
                        <span>&copy; 2024 RCCMË©¶È®ìÂïèÈ°åÈõÜ. All rights reserved.</span>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end justify-content-center gap-3 mt-2 mt-md-0">
                        <a href="#" class="text-muted text-decoration-none" aria-label="„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº">
                            üõ°Ô∏è „Éó„É©„Ç§„Éê„Ç∑„Éº
                        </a>
                        <a href="#" class="text-muted text-decoration-none" aria-label="Âà©Áî®Ë¶èÁ¥Ñ">
                            üìÑ Âà©Áî®Ë¶èÁ¥Ñ
                        </a>
                        <a href="#" class="text-muted text-decoration-none" aria-label="„ÅäÂïè„ÅÑÂêà„Çè„Åõ">
                            ‚úâÔ∏è „ÅäÂïè„ÅÑÂêà„Çè„Åõ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
            crossorigin="anonymous"></script>
    
    <!-- Enhanced Interactions -->
    <script src="{{ url_for('static', filename='js/enhanced_interactions.js') }}"></script>
    
    <!-- Disabled: Service Worker removed per user request -->
    <script>
        // Service Worker registration disabled - URL management only
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        // Service Worker registered successfully
                    })
                    .catch(registrationError => {
                        // Service Worker registration failed
                    });
            });
        }
        */
    </script>
    
    <!-- Performance Monitoring -->
    <script>
        // Web Vitals monitoring
        if ('PerformanceObserver' in window) {
            // Monitor LCP (Largest Contentful Paint)
            new PerformanceObserver((entryList) => {
                for (const entry of entryList.getEntries()) {
                    if (entry.startTime < 2500) { // Good LCP threshold
                        // Good LCP performance
                    } else {
                        // Poor LCP performance
                    }
                }
            }).observe({entryTypes: ['largest-contentful-paint']});
            
            // Monitor CLS (Cumulative Layout Shift)
            new PerformanceObserver((entryList) => {
                let clsValue = 0;
                for (const entry of entryList.getEntries()) {
                    if (!entry.hadRecentInput) {
                        clsValue += entry.value;
                    }
                }
                if (clsValue < 0.1) {
                    // Good CLS performance
                } else {
                    // Poor CLS performance
                }
            }).observe({entryTypes: ['layout-shift']});
        }
    </script>
    
    <!-- Accessibility Settings Restoration (Global) -->
    <script>
        // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Ë®≠ÂÆö„Çí„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Âæ©ÂÖÉÔºàÂÖ®„Éö„Éº„Ç∏ÂÖ±ÈÄöÔºâ
        document.addEventListener('DOMContentLoaded', function() {
            const fontSize = localStorage.getItem('rccm_font_size');
            const contrast = localStorage.getItem('rccm_contrast');
            const outdoor = localStorage.getItem('rccm_outdoor');

            if (fontSize === 'large') {
                document.body.style.fontSize = '1.2rem';
            }

            if (contrast === 'high') {
                document.body.classList.add('high-contrast-mode');
            }

            if (outdoor === 'enabled') {
                document.body.classList.add('outdoor-mode');
            }
        });
    </script>

    <!-- Custom Scripts -->
    {% block scripts %}{% endblock %}

    <!-- Error Tracking for Enhanced UI -->
    <script>
        window.addEventListener('error', function(e) {
            // Enhanced error tracking
            console.error('Enhanced UI Error:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error?.stack,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            });
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Enhanced UI Promise Rejection:', {
                reason: e.reason,
                stack: e.reason?.stack,
                timestamp: new Date().toISOString(),
                url: window.location.href
            });
        });
    </script>
</body>
</html>