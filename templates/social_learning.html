<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÇΩ„Éº„Ç∑„É£„É´Â≠¶Áøí - RCCMÂ≠¶Áøí„Ç¢„Éó„É™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome removed to prevent ‚ñ° character display issues -->
    <style>
        .social-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .social-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .group-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .discussion-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .peer-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .leaderboard-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        .tab-content {
            padding: 2rem 0;
        }
        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
            font-weight: 500;
        }
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .group-member {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            text-align: center;
            line-height: 40px;
            margin: 2px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .discussion-meta {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .vote-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .vote-btn {
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1.2rem;
            padding: 0.25rem;
        }
        .vote-btn:hover {
            color: #495057;
        }
        .vote-btn.voted {
            color: #007bff;
        }
        .match-score {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .ranking-badge {
            font-size: 1.5rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .rank-1 { background: #ffd700; color: #333; }
        .rank-2 { background: #c0c0c0; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #6c757d; }
        .progress-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(#667eea 0deg, #667eea var(--progress-angle, 0deg), #e9ecef var(--progress-angle, 0deg));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .progress-ring::before {
            content: '';
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            position: absolute;
        }
        .progress-text {
            position: relative;
            z-index: 1;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .activity-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
        }
        .activity-high { background: #28a745; }
        .activity-medium { background: #ffc107; }
        .activity-low { background: #dc3545; }
        .tag {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container">
                        <a class="navbar-brand" href="/">
                            üë• „ÇΩ„Éº„Ç∑„É£„É´Â≠¶Áøí
                        </a>
                        <div class="d-flex">
                            <a href="/" class="btn btn-outline-primary">
                                ‚¨ÖÔ∏è „É°„Ç§„É≥„Å´Êàª„Çã
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <div class="container mt-4">
            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <ul class="nav nav-pills justify-content-center mb-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#groups" data-bs-toggle="pill">
                        üë• Â≠¶Áøí„Ç∞„É´„Éº„Éó
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#discussions" data-bs-toggle="pill">
                        üí¨ „Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#peers" data-bs-toggle="pill">
                        üìà „Éî„Ç¢ÊØîËºÉ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#leaderboard" data-bs-toggle="pill">
                        <i class="fas fa-trophy me-2"></i>„É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Â≠¶Áøí„Ç∞„É´„Éº„Éó„Çø„Éñ -->
                <div class="tab-pane fade show active" id="groups">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h2><i class="fas fa-users me-2"></i>Â≠¶Áøí„Ç∞„É´„Éº„Éó</h2>
                            <p class="text-muted">Âêå„ÅòÁõÆÊ®ô„ÇíÊåÅ„Å§‰ª≤Èñì„Å®‰∏ÄÁ∑í„Å´Â≠¶Áøí„Åó„Åæ„Åó„Çá„ÅÜ</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                                <i class="fas fa-plus me-2"></i>„Ç∞„É´„Éº„Éó‰ΩúÊàê
                            </button>
                        </div>
                    </div>

                    <!-- ÂèÇÂä†‰∏≠„ÅÆ„Ç∞„É´„Éº„Éó -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4>ÂèÇÂä†‰∏≠„ÅÆ„Ç∞„É´„Éº„Éó</h4>
                            <div class="row" id="user-groups">
                                {% if user_groups %}
                                    {% for group in user_groups %}
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card social-card group-card">
                                            <div class="card-body">
                                                <h5 class="card-title">{{ group.name }}</h5>
                                                <p class="card-text">{{ group.description[:100] }}...</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small>
                                                        <i class="fas fa-users me-1"></i>{{ group.member_count }}‰∫∫
                                                        {% if group.is_creator %}
                                                            <i class="fas fa-crown ms-2" title="‰ΩúÊàêËÄÖ"></i>
                                                        {% elif group.is_moderator %}
                                                            <i class="fas fa-shield-alt ms-2" title="„É¢„Éá„É¨„Éº„Çø„Éº"></i>
                                                        {% endif %}
                                                    </small>
                                                    <button class="btn btn-light btn-sm" onclick="viewGroup('{{ group.id }}')">
                                                        Ë©≥Á¥∞
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            „Åæ„Å†„Ç∞„É´„Éº„Éó„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰∏ã„ÅÆ„Åä„Åô„Åô„ÇÅ„Ç∞„É´„Éº„Éó„Åã„ÇâÂèÇÂä†„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- „Åä„Åô„Åô„ÇÅ„Ç∞„É´„Éº„Éó -->
                    <div class="row">
                        <div class="col-12">
                            <h4>„Åä„Åô„Åô„ÇÅ„Ç∞„É´„Éº„Éó</h4>
                            <div class="row" id="recommended-groups">
                                {% if recommended_groups %}
                                    {% for rec in recommended_groups %}
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card social-card position-relative">
                                            <div class="match-score">{{ "%.0f"|format(rec.match_score * 100) }}%</div>
                                            <div class="card-body">
                                                <h5 class="card-title">{{ rec.group.name }}</h5>
                                                <p class="card-text">{{ rec.group.description[:100] }}...</p>
                                                <div class="mb-2">
                                                    {% for reason in rec.reasons %}
                                                    <span class="badge bg-secondary me-1">{{ reason }}</span>
                                                    {% endfor %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        <i class="fas fa-users me-1"></i>{{ rec.group.member_count }}‰∫∫
                                                        <br>{{ rec.group.department or 'ÂÖ®ÈÉ®ÈñÄ' }}
                                                    </small>
                                                    <button class="btn btn-outline-primary btn-sm" onclick="joinGroup('{{ rec.group.id }}')">
                                                        ÂèÇÂä†
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            ÁèæÂú®„Åä„Åô„Åô„ÇÅ„Åß„Åç„Çã„Ç∞„É´„Éº„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊñ∞„Åó„ÅÑ„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê„Åó„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Çø„Éñ -->
                <div class="tab-pane fade" id="discussions">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h2><i class="fas fa-comments me-2"></i>„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥</h2>
                            <p class="text-muted">ÁñëÂïè„ÇíËß£Ê±∫„Åó„ÄÅÁü•Ë≠ò„ÇíÂÖ±Êúâ„Åó„Åæ„Åó„Çá„ÅÜ</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDiscussionModal">
                                <i class="fas fa-plus me-2"></i>Êñ∞„Åó„ÅÑË©±È°å
                            </button>
                        </div>
                    </div>

                    <!-- „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-secondary active" onclick="filterDiscussions('all')">ÂÖ®„Å¶</button>
                                <button class="btn btn-outline-secondary" onclick="filterDiscussions('general')">‰∏ÄËà¨</button>
                                <button class="btn btn-outline-secondary" onclick="filterDiscussions('question')">ÂïèÈ°åËß£Ë™¨</button>
                                <button class="btn btn-outline-secondary" onclick="filterDiscussions('study_tips')">Â≠¶Áøí„ÅÆ„Ç≥„ÉÑ</button>
                                <button class="btn btn-outline-secondary" onclick="filterDiscussions('exam_info')">Ë©¶È®ìÊÉÖÂ†±</button>
                            </div>
                        </div>
                    </div>

                    <!-- „Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß -->
                    <div class="row" id="discussions-list">
                        {% if discussions %}
                            {% for discussion in discussions %}
                            <div class="col-12 mb-3">
                                <div class="card social-card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-1 text-center">
                                                <div class="vote-buttons">
                                                    <button class="vote-btn" onclick="voteDiscussion('{{ discussion.id }}', 'up')">
                                                        <i class="fas fa-chevron-up"></i>
                                                    </button>
                                                    <div class="fw-bold">{{ discussion.vote_score }}</div>
                                                    <button class="vote-btn" onclick="voteDiscussion('{{ discussion.id }}', 'down')">
                                                        <i class="fas fa-chevron-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-11">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <h5 class="card-title mb-1">
                                                        {% if discussion.is_pinned %}
                                                            <i class="fas fa-thumbtack text-warning me-2"></i>
                                                        {% endif %}
                                                        <a href="#" onclick="viewDiscussion('{{ discussion.id }}')" class="text-decoration-none">
                                                            {{ discussion.title }}
                                                        </a>
                                                        {% if discussion.is_solved %}
                                                            <span class="badge bg-success ms-2">Ëß£Ê±∫Ê∏à„Åø</span>
                                                        {% endif %}
                                                    </h5>
                                                    <span class="badge bg-primary">{{ discussion.category }}</span>
                                                </div>
                                                <div class="discussion-meta mb-2">
                                                    <i class="fas fa-user me-1"></i>{{ discussion.author_id }}
                                                    <i class="fas fa-clock ms-3 me-1"></i>{{ discussion.created_at[:10] }}
                                                    <i class="fas fa-eye ms-3 me-1"></i>{{ discussion.view_count }}
                                                    <i class="fas fa-comment ms-3 me-1"></i>{{ discussion.reply_count }}
                                                </div>
                                                <div class="tags">
                                                    {% for tag in discussion.tags %}
                                                    <span class="tag">{{ tag }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    „Åæ„Å†„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÂàù„ÅÆË©±È°å„ÇíÊäïÁ®ø„Åó„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- „Éî„Ç¢ÊØîËºÉ„Çø„Éñ -->
                <div class="tab-pane fade" id="peers">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h2><i class="fas fa-chart-line me-2"></i>„Éî„Ç¢ÊØîËºÉ</h2>
                            <p class="text-muted">Âêå„É¨„Éô„É´„ÅÆÂ≠¶ÁøíËÄÖ„Å®Ëá™ÂàÜ„ÅÆÂÆüÂäõ„ÇíÊØîËºÉ„Åó„Åæ„Åó„Çá„ÅÜ</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary active" onclick="loadPeerComparison('department')">
                                    ÈÉ®ÈñÄÂà•ÊØîËºÉ
                                </button>
                                <button class="btn btn-outline-primary" onclick="loadPeerComparison('level')">
                                    „É¨„Éô„É´Âà•ÊØîËºÉ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ÊØîËºÉÁµêÊûú -->
                    <div id="peer-comparison-results">
                        {% if peer_comparison and peer_comparison.user_stats %}
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card social-card peer-card">
                                    <div class="card-body text-center">
                                        <h4>„ÅÇ„Å™„Åü„ÅÆÊàêÁ∏æ</h4>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="progress-ring" style="--progress-angle: {{ (peer_comparison.user_stats.accuracy | default(0)) * 360 }}deg">
                                                    <div class="progress-text">{{ "%.1f"|format((peer_comparison.user_stats.accuracy | default(0)) * 100) }}%</div>
                                                </div>
                                                <div class="mt-2">Ê≠£Á≠îÁéá</div>
                                            </div>
                                            <div class="col-6">
                                                <h3>{{ peer_comparison.user_stats.total_questions | default(0) }}</h3>
                                                <div>ÂõûÁ≠îÊï∞</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card social-card">
                                    <div class="card-body">
                                        <h5>„Éî„Ç¢Âπ≥Âùá„Å®„ÅÆÊØîËºÉ</h5>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>Ê≠£Á≠îÁéá</span>
                                                <span class="fw-bold">
                                                    {{ "%.1f"|format(peer_comparison.user_stats.accuracy * 100) }}% 
                                                    vs 
                                                    {{ "%.1f"|format(peer_comparison.peer_stats.avg_accuracy * 100) }}%
                                                </span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar" 
                                                     style="width: {{ (peer_comparison.user_stats.accuracy / (peer_comparison.peer_stats.avg_accuracy or 1) * 100) | min(100) }}%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>Â≠¶ÁøíÈáè</span>
                                                <span class="fw-bold">
                                                    {{ peer_comparison.user_stats.total_questions }} 
                                                    vs 
                                                    {{ "%.0f"|format(peer_comparison.peer_stats.avg_total_questions) }}
                                                </span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar bg-success" 
                                                     style="width: {{ (peer_comparison.user_stats.total_questions / (peer_comparison.peer_stats.avg_total_questions or 1) * 100) | min(100) }}%"></div>
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <strong>„É©„É≥„Ç≠„É≥„Ç∞:</strong> {{ peer_comparison.rankings.user_rank }}‰Ωç / {{ peer_comparison.rankings.total_peers }}‰∫∫‰∏≠
                                            (‰∏ä‰Ωç{{ "%.1f"|format(peer_comparison.rankings.percentile) }}%)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÊîπÂñÑÊèêÊ°à -->
                        {% if peer_comparison.improvement_suggestions %}
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-lightbulb me-2"></i>ÊîπÂñÑÊèêÊ°à</h5>
                                    </div>
                                    <div class="card-body">
                                        {% for suggestion in peer_comparison.improvement_suggestions %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>{{ suggestion }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                            </div>
                            <p class="mt-3">ÊØîËºÉ„Éá„Éº„Çø„ÇíÂàÜÊûê‰∏≠...</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- „É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ„Çø„Éñ -->
                <div class="tab-pane fade" id="leaderboard">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h2><i class="fas fa-trophy me-2"></i>„É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ</h2>
                            <p class="text-muted">Â≠¶ÁøíËÄÖ„É©„É≥„Ç≠„É≥„Ç∞„ÅßÁ´∂„ÅÑÂêà„ÅÑ„Åæ„Åó„Çá„ÅÜ</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-outline-success active" onclick="loadLeaderboard('month')">
                                    ÊúàÈñì
                                </button>
                                <button class="btn btn-outline-success" onclick="loadLeaderboard('week')">
                                    ÈÄ±Èñì
                                </button>
                                <button class="btn btn-outline-success" onclick="loadLeaderboard('all')">
                                    ÂÖ®ÊúüÈñì
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- „É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ -->
                    <div id="leaderboard-content">
                        {% if leaderboard %}
                        <div class="row">
                            {% for user in leaderboard[:10] %}
                            <div class="col-12 mb-2">
                                <div class="card social-card leaderboard-card">
                                    <div class="card-body py-3">
                                        <div class="row align-items-center">
                                            <div class="col-md-1 text-center">
                                                <div class="ranking-badge rank-{{ '1' if user.rank == 1 else '2' if user.rank == 2 else '3' if user.rank == 3 else 'other' }}">
                                                    {{ user.rank }}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <h6 class="mb-1">{{ user.user_id }}</h6>
                                                <small>{{ user.department_focus or 'ÂÖ®ÈÉ®ÈñÄ' }}</small>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <div class="fw-bold">{{ "%.1f"|format(user.score) }}</div>
                                                <small>„Çπ„Ç≥„Ç¢</small>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <div class="fw-bold">{{ "%.1f"|format(user.accuracy * 100) }}%</div>
                                                <small>Ê≠£Á≠îÁéá</small>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <div class="fw-bold">{{ user.total_questions }}</div>
                                                <small>ÂïèÈ°åÊï∞</small>
                                            </div>
                                            <div class="col-md-2 text-center">
                                                <div class="fw-bold">{{ user.study_streak }}</div>
                                                <small>ÈÄ£Á∂öÊó•Êï∞</small>
                                                <div class="activity-indicator activity-{{ 'high' if user.total_questions > 50 else 'medium' if user.total_questions > 20 else 'low' }}"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            „Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Ç∞„É´„Éº„Éó‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Êñ∞„Åó„ÅÑÂ≠¶Áøí„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label class="form-label">„Ç∞„É´„Éº„ÉóÂêç *</label>
                            <input type="text" class="form-control" name="group_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ë™¨Êòé</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="„Ç∞„É´„Éº„Éó„ÅÆÁõÆÁöÑ„ÇÑÊ¥ªÂãïÂÜÖÂÆπ„ÇíË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Â∞ÇÈñÄÂàÜÈáé</label>
                            <select class="form-select" name="department">
                                <option value="">ÂÖ®ÈÉ®ÈñÄ</option>
                                <option value="ÈÅìË∑Ø">ÈÅìË∑Ø</option>
                                <option value="Ê≤≥Â∑ù„ÉªÁ†ÇÈò≤">Ê≤≥Â∑ù„ÉªÁ†ÇÈò≤</option>
                                <option value="Âª∫Ë®≠Áí∞Â¢É">Âª∫Ë®≠Áí∞Â¢É</option>
                                <option value="ÈÉΩÂ∏ÇË®àÁîª">ÈÉΩÂ∏ÇË®àÁîª</option>
                                <option value="Ëæ≤Ê•≠ÂúüÊú®">Ëæ≤Ê•≠ÂúüÊú®</option>
                                <option value="Ê£ÆÊûóÂúüÊú®">Ê£ÆÊûóÂúüÊú®</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ÁõÆÊ®ôË©¶È®ìÊó•</label>
                            <input type="date" class="form-control" name="target_exam_date">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" onclick="createGroup()">‰ΩúÊàê</button>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="createDiscussionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Êñ∞„Åó„ÅÑ„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Çí‰ΩúÊàê</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createDiscussionForm">
                        <div class="mb-3">
                            <label class="form-label">„Çø„Ç§„Éà„É´ *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">„Ç´„ÉÜ„Ç¥„É™</label>
                            <select class="form-select" name="category">
                                <option value="general">‰∏ÄËà¨</option>
                                <option value="question">ÂïèÈ°åËß£Ë™¨</option>
                                <option value="study_tips">Â≠¶Áøí„ÅÆ„Ç≥„ÉÑ</option>
                                <option value="exam_info">Ë©¶È®ìÊÉÖÂ†±</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ÂÜÖÂÆπ *</label>
                            <textarea class="form-control" name="content" rows="5" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Èñ¢ÈÄ£ÂïèÈ°åIDÔºà‰ªªÊÑèÔºâ</label>
                            <input type="number" class="form-control" name="question_id">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" onclick="createDiscussion()">ÊäïÁ®ø</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // „Ç∞„É´„Éº„Éó‰ΩúÊàê
        function createGroup() {
            const form = document.getElementById('createGroupForm');
            const formData = new FormData(form);
            
            fetch('/social/create_group', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('„Ç∞„É´„Éº„Éó„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                    location.reload();
                } else {
                    alert('„Ç®„É©„Éº: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Ç∞„É´„Éº„Éó‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            });
        }

        // „Ç∞„É´„Éº„ÉóÂèÇÂä†
        function joinGroup(groupId) {
            if (confirm('„Åì„ÅÆ„Ç∞„É´„Éº„Éó„Å´ÂèÇÂä†„Åó„Åæ„Åô„ÅãÔºü')) {
                fetch('/social/join_group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `group_id=${groupId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('„Ç∞„É´„Éº„Éó„Å´ÂèÇÂä†„Åó„Åæ„Åó„ÅüÔºÅ');
                        location.reload();
                    } else {
                        alert('„Ç®„É©„Éº: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('„Ç∞„É´„Éº„ÉóÂèÇÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                });
            }
        }

        // „Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
        function createDiscussion() {
            const form = document.getElementById('createDiscussionForm');
            const formData = new FormData(form);
            
            fetch('/social/create_discussion', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                    location.reload();
                } else {
                    alert('„Ç®„É©„Éº: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Éá„Ç£„Çπ„Ç´„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            });
        }

        // „Éî„Ç¢ÊØîËºÉË™≠„ÅøËæº„Åø
        function loadPeerComparison(type) {
            document.getElementById('peer-comparison-results').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                    </div>
                    <p class="mt-3">ÊØîËºÉ„Éá„Éº„Çø„ÇíÂàÜÊûê‰∏≠...</p>
                </div>
            `;
            
            fetch(`/social/peer_comparison?type=${type}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('peer-comparison-results').innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('peer-comparison-results').innerHTML = `
                    <div class="alert alert-danger">
                        „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü
                    </div>
                `;
            });
        }

        // „É™„Éº„ÉÄ„Éº„Éú„Éº„ÉâË™≠„ÅøËæº„Åø
        function loadLeaderboard(period) {
            document.getElementById('leaderboard-content').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                    </div>
                    <p class="mt-3">„É©„É≥„Ç≠„É≥„Ç∞„ÇíÊõ¥Êñ∞‰∏≠...</p>
                </div>
            `;
            
            fetch(`/social/leaderboard?period=${period}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('leaderboard-content').innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('leaderboard-content').innerHTML = `
                    <div class="alert alert-danger">
                        „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü
                    </div>
                `;
            });
        }

        // „Åù„ÅÆ‰ªñ„ÅÆÈñ¢Êï∞
        function viewGroup(groupId) {
            window.open(`/social/group/${groupId}`, '_blank');
        }

        function viewDiscussion(discussionId) {
            window.open(`/social/discussion/${discussionId}`, '_blank');
        }

        function voteDiscussion(discussionId, voteType) {
            fetch('/social/vote_discussion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `discussion_id=${discussionId}&vote_type=${voteType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function filterDiscussions(category) {
            // „Éï„Ç£„É´„Çø„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // „Éï„Ç£„É´„ÇøÂá¶ÁêÜÔºàÁ∞°Áï•ÂåñÔºâ
            const discussions = document.querySelectorAll('#discussions-list .col-12');
            discussions.forEach(discussion => {
                if (category === 'all') {
                    discussion.style.display = 'block';
                } else {
                    const badge = discussion.querySelector('.badge');
                    if (badge && badge.textContent === category) {
                        discussion.style.display = 'block';
                    } else {
                        discussion.style.display = 'none';
                    }
                }
            });
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„ÅÆÂá¶ÁêÜ
            document.querySelectorAll('a[data-bs-toggle="pill"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const target = event.target.getAttribute('href');
                    if (target === '#peers' && !document.querySelector('#peer-comparison-results .card')) {
                        loadPeerComparison('department');
                    }
                    if (target === '#leaderboard' && !document.querySelector('#leaderboard-content .card')) {
                        loadLeaderboard('month');
                    }
                });
            });
        });
    </script>
</body>
</html>